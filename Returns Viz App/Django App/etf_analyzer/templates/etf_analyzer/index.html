{% extends 'etf_analyzer/base.html' %}

{% block content %}
<style>
/* BLOOMBERG TERMINAL THEME VARIABLES */
:root {
    /* Inherit from base.html terminal colors */
    --terminal-black: #0a0a0a;
    --terminal-dark: #141414;
    --terminal-darker: #1a1a1a;
    --terminal-grid: #262626;
    --terminal-border: #333333;
    
    --bloomberg-orange: #ff6600;
    --bloomberg-orange-bright: #ff8533;
    --bloomberg-orange-glow: #ff9d4d;
    --bloomberg-orange-dark: #cc5200;
    
    --data-green: #00ff41;
    --data-red: #ff0040;
    --data-blue: #00b4ff;
    --data-yellow: #ffcc00;
    --data-purple: #cc00ff;
    
    --text-primary: #ffffff;
    --text-secondary: #b3b3b3;
    --text-tertiary: #808080;
    --text-quaternary: #666666;
    
    --glow-orange: 0 0 20px rgba(255, 102, 0, 0.6);
    --glow-green: 0 0 15px rgba(0, 255, 65, 0.5);
    --glow-red: 0 0 15px rgba(255, 0, 64, 0.5);
    --glow-blue: 0 0 15px rgba(0, 180, 255, 0.5);
    --glow-purple: 0 0 15px rgba(204, 0, 255, 0.5);
}
/* BLOOMBERG TERMINAL PERFORMANCE CARDS - NUCLEAR MODE */
.performance-card-returns {
    background: var(--terminal-dark);
    border: 1px solid var(--data-green);
    border-left: 3px solid var(--data-green);
    box-shadow: 
        inset 0 0 20px rgba(0, 255, 65, 0.05),
        0 0 15px rgba(0, 255, 65, 0.1);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.performance-card-returns:hover {
    border-color: var(--data-green);
    box-shadow: 
        inset 0 0 30px rgba(0, 255, 65, 0.1),
        0 0 30px rgba(0, 255, 65, 0.2),
        var(--glow-green);
}

.performance-card-returns::before {
    content: 'RETURNS';
    position: absolute;
    top: -12px;
    left: 10px;
    background: var(--terminal-dark);
    color: var(--data-green);
    padding: 2px 8px;
    font-size: 9px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    letter-spacing: 2px;
    border: 1px solid var(--data-green);
    z-index: 10;
}

.performance-card-returns .performance-card-header {
    color: var(--data-green);
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
}

.performance-card-risk {
    background: var(--terminal-dark);
    border: 1px solid var(--bloomberg-orange-dark);
    border-left: 3px solid var(--bloomberg-orange);
    box-shadow: 
        inset 0 0 20px rgba(255, 102, 0, 0.05),
        0 0 15px rgba(255, 102, 0, 0.1);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.performance-card-risk:hover {
    border-color: var(--bloomberg-orange);
    box-shadow: 
        inset 0 0 30px rgba(255, 102, 0, 0.1),
        0 0 30px rgba(255, 102, 0, 0.2),
        var(--glow-orange);
}

.performance-card-risk::before {
    content: 'RISK';
    position: absolute;
    top: -12px;
    left: 10px;
    background: var(--terminal-dark);
    color: var(--bloomberg-orange);
    padding: 2px 8px;
    font-size: 9px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    letter-spacing: 2px;
    border: 1px solid var(--bloomberg-orange-dark);
    z-index: 10;
}

.performance-card-risk .performance-card-header {
    color: var(--bloomberg-orange);
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 10px rgba(255, 102, 0, 0.5);
}

.performance-card-adjusted {
    background: var(--terminal-dark);
    border: 1px solid var(--data-blue);
    border-left: 3px solid var(--data-blue);
    box-shadow: 
        inset 0 0 20px rgba(0, 180, 255, 0.05),
        0 0 15px rgba(0, 180, 255, 0.1);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.performance-card-adjusted:hover {
    border-color: var(--data-blue);
    box-shadow: 
        inset 0 0 30px rgba(0, 180, 255, 0.1),
        0 0 30px rgba(0, 180, 255, 0.2),
        var(--glow-blue);
}

.performance-card-adjusted::before {
    content: 'ADJUSTED';
    position: absolute;
    top: -12px;
    left: 10px;
    background: var(--terminal-dark);
    color: var(--data-blue);
    padding: 2px 8px;
    font-size: 9px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    letter-spacing: 2px;
    border: 1px solid var(--data-blue);
    z-index: 10;
}

.performance-card-adjusted .performance-card-header {
    color: var(--data-blue);
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 10px rgba(0, 180, 255, 0.5);
}

.performance-card-relative {
    background: var(--terminal-dark);
    border: 1px solid var(--data-purple);
    border-left: 3px solid var(--data-purple);
    box-shadow: 
        inset 0 0 20px rgba(204, 0, 255, 0.05),
        0 0 15px rgba(204, 0, 255, 0.1);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.performance-card-relative:hover {
    border-color: var(--data-purple);
    box-shadow: 
        inset 0 0 30px rgba(204, 0, 255, 0.1),
        0 0 30px rgba(204, 0, 255, 0.2),
        var(--glow-purple);
}

.performance-card-relative::before {
    content: 'RELATIVE';
    position: absolute;
    top: -12px;
    left: 10px;
    background: var(--terminal-dark);
    color: var(--data-purple);
    padding: 2px 8px;
    font-size: 9px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    letter-spacing: 2px;
    border: 1px solid var(--data-purple);
    z-index: 10;
}

.performance-card-relative .performance-card-header {
    color: var(--data-purple);
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 10px rgba(204, 0, 255, 0.5);
}

/* Bloomberg Terminal metric values */
.performance-card-returns .metric-value { 
    color: var(--data-green); 
    text-shadow: 0 0 5px rgba(0, 255, 65, 0.3);
}
.performance-card-risk .metric-value { 
    color: var(--bloomberg-orange); 
    text-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
}
.performance-card-adjusted .metric-value { 
    color: var(--data-blue); 
    text-shadow: 0 0 5px rgba(0, 180, 255, 0.3);
}
.performance-card-relative .metric-value { 
    color: var(--data-purple); 
    text-shadow: 0 0 5px rgba(204, 0, 255, 0.3);
}

/* Add purple glow effect */
:root {
    --glow-purple: 0 0 15px rgba(204, 0, 255, 0.5);
}

/* Subtle background pattern */
.performance-card {
    position: relative;
    overflow: hidden;
}

.performance-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                      radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

/* BLOOMBERG TERMINAL OVERVIEW CARD */
.overview-showcase {
    margin: 30px 20px;
    padding: 0;
}

.overview-card {
    background: var(--terminal-dark);
    border: 2px solid var(--bloomberg-orange-dark);
    border-radius: 0;
    padding: 30px;
    position: relative;
    overflow: visible;
    box-shadow: 
        inset 0 0 30px rgba(255, 102, 0, 0.1),
        0 0 40px rgba(255, 102, 0, 0.15);
    transform: translateY(0);
    transition: all 0.3s ease;
}

/* Terminal Header Label */
.overview-card::before {
    content: 'ANALYTICS ENGINE // PERFORMANCE METRICS';
    position: absolute;
    top: -2px;
    left: -2px;
    background: var(--terminal-black);
    color: var(--bloomberg-orange);
    padding: 5px 20px;
    font-size: 11px;
    font-weight: 700;
    font-family: 'Orbitron', monospace;
    letter-spacing: 2px;
    border: 2px solid var(--bloomberg-orange-dark);
    border-bottom: none;
    z-index: 10;
}

.overview-card:hover {
    box-shadow: 
        inset 0 0 40px rgba(255, 102, 0, 0.15),
        0 0 60px rgba(255, 102, 0, 0.2),
        var(--glow-orange);
    border-color: var(--bloomberg-orange);
}

/* Data Stream Animation */
.overview-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        linear-gradient(0deg, transparent 0%, rgba(255, 102, 0, 0.05) 50%, transparent 100%);
    background-size: 100% 20px;
    animation: dataFlow 2s linear infinite;
    pointer-events: none;
}

@keyframes dataFlow {
    0% { transform: translateY(0); }
    100% { transform: translateY(20px); }
}

.overview-header {
    display: flex;
    align-items: center;
    margin-bottom: 2rem;
    position: relative;
    z-index: 2;
}

.overview-icon {
    background: var(--terminal-black);
    border: 2px solid var(--bloomberg-orange-dark);
    border-radius: 0;
    padding: 15px;
    margin-right: 20px;
    box-shadow: 
        inset 0 0 15px rgba(255, 102, 0, 0.2),
        0 0 20px rgba(255, 102, 0, 0.1);
    position: relative;
}

.overview-svg {
    width: 30px;
    height: 30px;
    color: var(--bloomberg-orange);
    stroke-width: 2;
    filter: drop-shadow(0 0 10px rgba(255, 102, 0, 0.6));
    animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.overview-title {
    color: var(--bloomberg-orange);
    font-size: 1.8rem;
    font-weight: 800;
    margin: 0;
    font-family: 'Orbitron', monospace;
    text-transform: uppercase;
    letter-spacing: 3px;
    text-shadow: 
        0 0 10px var(--bloomberg-orange),
        0 0 20px var(--bloomberg-orange-dark);
}

.overview-content {
    position: relative;
    z-index: 2;
}

.formula-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
    margin-top: 40px;
}

.formula-item {
    background: var(--terminal-black);
    border: 1px solid var(--terminal-border);
    border-radius: 0;
    padding: 20px;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
}

.formula-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    transition: all 0.3s ease;
}

.formula-item.cagr-theme::before {
    background: var(--data-blue);
    box-shadow: 0 0 10px var(--data-blue);
}

.formula-item.total-return-theme::before {
    background: var(--data-green);
    box-shadow: 0 0 10px var(--data-green);
}

.formula-item.simple-annualized-theme::before {
    background: var(--bloomberg-orange);
    box-shadow: 0 0 10px var(--bloomberg-orange);
}

/* Comparative Analysis Formula Themes */
.formula-item.cagr-difference-theme::before {
    background: var(--data-green);
    box-shadow: 0 0 10px var(--data-green);
}

.formula-item.total-return-difference-theme::before {
    background: var(--data-green);
    box-shadow: 0 0 10px var(--data-green);
}

.formula-item.simple-annualized-difference-theme::before {
    background: var(--data-green);
    box-shadow: 0 0 10px var(--data-green);
}

.formula-item.cagr-ratio-theme::before {
    background: #00b4ff;
    box-shadow: 0 0 10px #00b4ff;
}

.formula-item.total-return-ratio-theme::before {
    background: #00b4ff;
    box-shadow: 0 0 10px #00b4ff;
}

.formula-item.simple-annualized-ratio-theme::before {
    background: #00b4ff;
    box-shadow: 0 0 10px #00b4ff;
}

.formula-item:hover {
    border-color: var(--bloomberg-orange-dark);
    box-shadow: 
        inset 0 0 25px rgba(255, 102, 0, 0.1),
        0 0 20px rgba(255, 102, 0, 0.1);
}

.formula-label {
    color: var(--bloomberg-orange);
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-family: 'Orbitron', monospace;
}

.formula-equation {
    color: var(--data-green);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 15px;
    background: rgba(0, 255, 65, 0.05);
    padding: 10px;
    border-radius: 0;
    border: 1px solid rgba(0, 255, 65, 0.2);
    text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
}

.formula-desc {
    color: var(--text-secondary);
    font-size: 0.8rem;
    line-height: 1.5;
    font-family: 'Share Tech Mono', monospace;
    opacity: 0.9;
}

.metrics-overview {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.metrics-badge {
    display: flex;
    align-items: center;
    background: var(--terminal-black);
    border: 1px solid var(--terminal-border);
    border-radius: 0;
    padding: 15px 20px;
    transition: all 0.2s ease;
    flex: 1;
    min-width: 280px;
    position: relative;
    overflow: hidden;
}

.metrics-badge::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--bloomberg-orange);
    transition: width 0.3s ease;
}

.metrics-badge:hover {
    border-color: var(--bloomberg-orange-dark);
    box-shadow: 
        inset 0 0 20px rgba(255, 102, 0, 0.1),
        0 0 15px rgba(255, 102, 0, 0.1);
}

.metrics-badge:hover::before {
    width: 100%;
    opacity: 0.1;
}

.badge-text {
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 400;
    line-height: 1.4;
    font-family: 'Share Tech Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
    z-index: 2;
    position: relative;
}

/* Matrix Type Group Styling */
.matrix-type-group {
    margin-bottom: 15px;
}

.matrix-subgroup {
    margin-bottom: 10px;
}

.matrix-subgroup-label {
    color: var(--bloomberg-orange);
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 8px;
    font-family: 'Share Tech Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.matrix-subgroup .btn-group {
    flex-wrap: wrap;
    gap: 5px;
}

.matrix-subgroup .btn {
    font-size: 0.85rem;
    padding: 8px 12px;
    font-family: 'JetBrains Mono', monospace;
}

/* Year Input Styling */
.year-input {
    font-size: 1rem;
    font-weight: 500;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
}

.year-display {
    font-size: 1.1rem;
    font-weight: 700;
    text-align: center;
    color: var(--bloomberg-orange);
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 1px;
}

@media (max-width: 768px) {
    .formula-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    /* Responsive matrix type buttons */
    .matrix-subgroup .btn-group {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    
    .matrix-subgroup .btn {
        margin-bottom: 5px;
    }
    

}

@media (min-width: 769px) and (max-width: 1024px) {
    .formula-grid {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
    }
    
    .formula-item {
        padding: 15px;
    }
    
    .overview-card {
        padding: 1.5rem;
    }
    
    .overview-title {
        font-size: 1.5rem;
    }
    
    .metrics-badge {
        min-width: 100%;
    }
}
</style>
    <!-- Company Header -->
    <div class="company-header">
        <h1 class="company-name">PEARSON CREEK CAPITAL LLC</h1>
        <p class="company-tagline">Professional ETF Performance Analysis & Investment Research</p>
    </div>
    
    <!-- Overview Card -->
    <div class="overview-showcase">
        <div class="overview-card">
            <div class="overview-header">
                <div class="overview-icon">
                    <svg class="overview-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <h3 class="overview-title">Investment Performance Analytics</h3>
            </div>
            
            <div class="overview-content">
                <!-- Single Analysis Formulas -->
                <div class="formula-grid" id="singleFormulas">
                    <div class="formula-item cagr-theme">
                        <div class="formula-label">CAGR Formula</div>
                        <div class="formula-equation">(End Value / Start Value)^(1/Years) - 1</div>
                        <div class="formula-desc">Annualized growth rate over multiple periods</div>
                    </div>
                    
                    <div class="formula-item total-return-theme">
                        <div class="formula-label">Total Return Formula</div>
                        <div class="formula-equation">(End Value / Start Value) - 1</div>
                        <div class="formula-desc">Cumulative growth between two points</div>
                    </div>
                    
                    <div class="formula-item simple-annualized-theme">
                        <div class="formula-label">Simple Annualized Return Formula</div>
                        <div class="formula-equation">Total Return ÷ Number of Years</div>
                        <div class="formula-desc">Average annual return without compounding</div>
                    </div>
                </div>
                
                <!-- Comparative Analysis Formulas -->
                <div class="formula-grid" id="comparativeFormulas" style="display: none;">
                    <!-- Difference Formulas -->
                    <div class="formula-item cagr-difference-theme">
                        <div class="formula-label">CAGR Difference Formula</div>
                        <div class="formula-equation">Primary CAGR - Benchmark CAGR</div>
                        <div class="formula-desc">Absolute outperformance in percentage points</div>
                    </div>
                    
                    <div class="formula-item total-return-difference-theme">
                        <div class="formula-label">Total Return Difference Formula</div>
                        <div class="formula-equation">Primary Total Return - Benchmark Total Return</div>
                        <div class="formula-desc">Absolute cumulative outperformance</div>
                    </div>
                    
                    <div class="formula-item simple-annualized-difference-theme">
                        <div class="formula-label">Simple Annualized Difference Formula</div>
                        <div class="formula-equation">Primary Simple Ann. - Benchmark Simple Ann.</div>
                        <div class="formula-desc">Average annual outperformance without compounding</div>
                    </div>
                    
                    <!-- Ratio Formulas -->
                    <div class="formula-item cagr-ratio-theme">
                        <div class="formula-label">CAGR Ratio Formula</div>
                        <div class="formula-equation">Primary CAGR ÷ Benchmark CAGR</div>
                        <div class="formula-desc">Relative performance ratio (>1.0 = outperformance)</div>
                    </div>
                    
                    <div class="formula-item total-return-ratio-theme">
                        <div class="formula-label">Total Return Ratio Formula</div>
                        <div class="formula-equation">Primary Total Return ÷ Benchmark Total Return</div>
                        <div class="formula-desc">Cumulative relative performance ratio</div>
                    </div>
                    
                    <div class="formula-item simple-annualized-ratio-theme">
                        <div class="formula-label">Simple Annualized Ratio Formula</div>
                        <div class="formula-equation">Primary Simple Ann. ÷ Benchmark Simple Ann.</div>
                        <div class="formula-desc">Average annual relative performance ratio</div>
                    </div>
                </div>
                
                <div class="metrics-overview">
                    <div class="metrics-badge">
                        <span class="badge-text">Interactive heatmap matrix visualization</span>
                    </div>
                    <div class="metrics-badge">
                        <span class="badge-text">Risk-adjusted performance metrics</span>
                    </div>
                    <div class="metrics-badge">
                        <span class="badge-text">Multi-timeframe comparative analysis</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <!-- Analysis Mode Toggle -->
        <div class="row mb-4">
            <div class="col-12">
                <label class="form-label">Analysis Mode:</label>
                <div class="btn-group" role="group" id="analysisModeToggle">
                    <input type="radio" class="btn-check" name="analysisMode" id="singleModeRadio" value="Single" checked>
                    <label class="btn btn-outline-warning" for="singleModeRadio">Single Ticker Analysis</label>
                    
                    <input type="radio" class="btn-check" name="analysisMode" id="comparativeModeRadio" value="Comparative">
                    <label class="btn btn-outline-warning" for="comparativeModeRadio">Comparative Analysis</label>
                </div>
                <div class="form-text" id="analysisModeDescription">Analyze a single ticker's performance over time</div>
            </div>
        </div>
        
        <!-- Single Mode Layout: All in one row -->
        <div class="row g-3" id="singleModeControls">
            <div class="col-md-3">
                <label for="tickerInput" class="form-label">Ticker Symbol:</label>
                <div class="ticker-input-container">
                    <div class="input-group">
                        <input type="text" class="form-control" id="tickerInput" placeholder="e.g., AAPL, SPY, MSFT" 
                               value="AAPL" autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="validateTicker">
                            <i class="bi bi-check-circle"></i> Validate
                        </button>
                    </div>
                    <div id="tickerSuggestions" class="ticker-suggestions" style="display: none;"></div>
                </div>
                <div class="form-text" id="tickerInfo"></div>
                <div class="invalid-feedback" id="tickerError" style="display: none;"></div>
            </div>
            
            <div class="col-md-3">
                <label for="periodSelect" class="form-label">Time Period:</label>
                <select class="form-select" id="periodSelect">
                    {% for period, values in time_periods.items %}
                        <option value="{{ period }}" {% if forloop.first %}selected{% endif %}>{{ period }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Start Year:</label>
                <input type="number" class="form-control year-input" id="startYear" value="2014" min="1990" max="2025">
            </div>
            
            <div class="col-md-3">
                <label class="form-label">End Year:</label>
                <input type="number" class="form-control year-input" id="endYear" value="2025" min="1990" max="2025">
            </div>
        </div>

        <!-- Comparative Mode Layout: 2 rows -->
        <div id="comparativeModeControls" style="display: none;">
            <!-- Row 1: Ticker Inputs -->
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="tickerInput2" class="form-label">Primary Ticker Symbol:</label>
                    <div class="ticker-input-container">
                        <div class="input-group">
                            <input type="text" class="form-control" id="tickerInput2" placeholder="e.g., AAPL, SPY, MSFT" 
                                   value="AAPL" autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" id="validateTicker2">
                                <i class="bi bi-check-circle"></i> Validate
                            </button>
                        </div>
                        <div id="tickerSuggestions2" class="ticker-suggestions" style="display: none;"></div>
                    </div>
                    <div class="form-text" id="tickerInfo2"></div>
                    <div class="invalid-feedback" id="tickerError2" style="display: none;"></div>
                </div>
                
                <!-- Benchmark Ticker Input -->
                <div class="col-md-6" id="benchmarkTickerContainer">
                    <label for="benchmarkTickerInput" class="form-label">Benchmark Ticker Symbol:</label>
                    <div class="ticker-input-container">
                        <div class="input-group">
                            <input type="text" class="form-control" id="benchmarkTickerInput" placeholder="e.g., SPY, QQQ, VTI" 
                                   value="SPY" autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" id="validateBenchmarkTicker">
                                <i class="bi bi-check-circle"></i> Validate
                            </button>
                        </div>
                        <div id="benchmarkTickerSuggestions" class="ticker-suggestions" style="display: none;"></div>
                    </div>
                    <div class="form-text" id="benchmarkTickerInfo"></div>
                    <div class="invalid-feedback" id="benchmarkTickerError" style="display: none;"></div>
                </div>
            </div>
            
            <!-- Row 2: Time Period and Years -->
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="periodSelect2" class="form-label">Time Period:</label>
                    <select class="form-select" id="periodSelect2">
                        {% for period, values in time_periods.items %}
                            <option value="{{ period }}" {% if forloop.first %}selected{% endif %}>{{ period }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Start Year:</label>
                    <input type="number" class="form-control year-input" id="startYear2" value="2014" min="1990" max="2025">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">End Year:</label>
                    <input type="number" class="form-control year-input" id="endYear2" value="2025" min="1990" max="2025">
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <button class="btn btn-primary" id="updateButton">Update Analysis</button>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <label class="form-label">Matrix Type:</label>
                
                <!-- Single Analysis Matrix Types -->
                <div id="singleMatrixTypes" class="matrix-type-group">
                    <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="matrixType" id="cagrRadio" value="CAGR" checked>
                    <label class="btn btn-outline-primary" for="cagrRadio">CAGR</label>
                    
                    <input type="radio" class="btn-check" name="matrixType" id="totalReturnRadio" value="Total Return">
                    <label class="btn btn-outline-primary" for="totalReturnRadio">Total Return</label>
                        
                        <input type="radio" class="btn-check" name="matrixType" id="simpleAnnualizedRadio" value="Simple Annualized Return">
                        <label class="btn btn-outline-primary" for="simpleAnnualizedRadio">Simple Annualized</label>
                </div>
                </div>
                
                <!-- Comparative Analysis Matrix Types -->
                <div id="comparativeMatrixTypes" class="matrix-type-group" style="display: none;">
                    <!-- Difference Metrics -->
                    <div class="matrix-subgroup mb-3">
                        <div class="matrix-subgroup-label">Difference (Primary - Benchmark):</div>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="matrixType" id="cagrDifferenceRadio" value="CAGR Difference">
                            <label class="btn btn-outline-success" for="cagrDifferenceRadio">CAGR Diff</label>
                            
                            <input type="radio" class="btn-check" name="matrixType" id="totalReturnDifferenceRadio" value="Total Return Difference">
                            <label class="btn btn-outline-success" for="totalReturnDifferenceRadio">Total Return Diff</label>
                            
                            <input type="radio" class="btn-check" name="matrixType" id="simpleAnnualizedDifferenceRadio" value="Simple Annualized Return Difference">
                            <label class="btn btn-outline-success" for="simpleAnnualizedDifferenceRadio">Simple Ann. Diff</label>
                        </div>
                    </div>
                    
                    <!-- Ratio Metrics -->
                    <div class="matrix-subgroup">
                        <div class="matrix-subgroup-label">Ratio (Primary ÷ Benchmark):</div>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="matrixType" id="cagrRatioRadio" value="CAGR Ratio">
                            <label class="btn btn-outline-info" for="cagrRatioRadio">CAGR Ratio</label>
                            
                            <input type="radio" class="btn-check" name="matrixType" id="totalReturnRatioRadio" value="Total Return Ratio">
                            <label class="btn btn-outline-info" for="totalReturnRatioRadio">Total Return Ratio</label>
                            
                            <input type="radio" class="btn-check" name="matrixType" id="simpleAnnualizedRatioRadio" value="Simple Annualized Return Ratio">
                            <label class="btn btn-outline-info" for="simpleAnnualizedRatioRadio">Simple Ann. Ratio</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-text" id="matrixTypeInfo">
                    <span id="matrixTypeDescription">CAGR shows annualized returns between periods</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading market data...</p>
    </div>
    
    <!-- Error Alert -->
    <div id="errorAlert" class="alert alert-danger" style="display: none;" role="alert"></div>
    
    <!-- Heatmap Container -->
    <div id="heatmapContainer" class="matrix-container" style="display: none;">
        <div id="heatmapPlot"></div>
    </div>
    
    <!-- Instructions -->
    <div id="instructions" class="instructions" style="display: none;">
        <h4>📖 How to Read This Interactive Heatmap</h4>
        <ul>
            <li><strong>X-axis (From the start of):</strong> Starting year of investment period</li>
            <li><strong>Y-axis (To the end of):</strong> Ending year of investment period</li>
            <li><strong>Cell Values:</strong> Compound Annual Growth Rate (CAGR) for that specific time period</li>
            <li><strong>Color Coding:</strong> Red shades for negative returns, green shades for positive returns</li>
            <li><strong>Text Color:</strong> Dynamically adjusted (black/white) for optimal readability</li>
            <li><strong>Interactive:</strong> Hover over cells to see detailed CAGR information</li>
        </ul>
    </div>
    
    <!-- Key Statistics -->
    <div id="statsContainer" class="row g-3 mt-4" style="display: none;">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="bestSingleYear">-</div>
                <div class="stat-label" id="bestSingleYearLabel">Best Single Year</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="worstSingleYear">-</div>
                <div class="stat-label" id="worstSingleYearLabel">Worst Single Year</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="tenYearCAGR">-</div>
                <div class="stat-label" id="tenYearCAGRLabel">10-Year CAGR</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="fullPeriodCAGR">-</div>
                <div class="stat-label" id="fullPeriodCAGRLabel">Full Period CAGR</div>
            </div>
        </div>
    </div>
    
    <!-- Performance Overview -->
    <div id="performanceContainer" class="mt-5" style="display: none; background: #1a1a1a; padding: 20px; border: 2px solid #ff6600;">

        <h3 style="color: var(--bloomberg-orange); font-family: 'Orbitron', monospace; text-transform: uppercase; letter-spacing: 2px;">Performance Overview</h3>
        <!-- NEW BLOOMBERG PERFORMANCE CARDS -->
        <div class="performance-grid">
            <!-- Return Metrics Card -->
            <div class="bloomberg-metric-card" data-metric-type="returns">
                <div class="bloomberg-card-header">
                    <span class="bloomberg-card-title">RETURN METRICS</span>
                        </div>
                <div class="bloomberg-card-body">
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">CAGR</span>
                        <span class="bloomberg-metric-value" id="perf-cagr">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">TOTAL RETURN</span>
                        <span class="bloomberg-metric-value" id="perf-total-return">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">SIMPLE ANNUALIZED</span>
                        <span class="bloomberg-metric-value" id="perf-simple-annualized">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">BEST YEAR</span>
                        <span class="bloomberg-metric-value" id="perf-best-year">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">WORST YEAR</span>
                        <span class="bloomberg-metric-value" id="perf-worst-year">-</span>
                    </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">WIN RATE</span>
                        <span class="bloomberg-metric-value" id="perf-win-rate">-</span>
                    </div>
                </div>
            </div>

            <!-- Risk Metrics Card -->
            <div class="bloomberg-metric-card" data-metric-type="risk">
                <div class="bloomberg-card-header">
                    <span class="bloomberg-card-title">RISK METRICS</span>
                        </div>
                <div class="bloomberg-card-body">
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">VOLATILITY</span>
                        <span class="bloomberg-metric-value" id="perf-volatility">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">MAX DRAWDOWN</span>
                        <span class="bloomberg-metric-value" id="perf-max-dd">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">RECOVERY DAYS</span>
                        <span class="bloomberg-metric-value" id="perf-recovery">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">VAR (5%)</span>
                        <span class="bloomberg-metric-value" id="perf-var">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">PAIN INDEX</span>
                        <span class="bloomberg-metric-value" id="perf-pain">-</span>
                    </div>
                </div>
            </div>

            <!-- Risk-Adjusted Card -->
            <div class="bloomberg-metric-card" data-metric-type="adjusted">
                <div class="bloomberg-card-header">
                    <span class="bloomberg-card-title">RISK-ADJUSTED RETURNS</span>
                        </div>
                <div class="bloomberg-card-body">
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">SHARPE RATIO</span>
                        <span class="bloomberg-metric-value" id="perf-sharpe">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">SORTINO RATIO</span>
                        <span class="bloomberg-metric-value" id="perf-sortino">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">CALMAR RATIO</span>
                        <span class="bloomberg-metric-value" id="perf-calmar">-</span>
                    </div>
                </div>
            </div>

            <!-- Relative Performance Card -->
            <div class="bloomberg-metric-card" data-metric-type="relative">
                <div class="bloomberg-card-header">
                    <span class="bloomberg-card-title" id="relative-performance-title">AAPL Performance</span>
                        </div>
                <div class="bloomberg-card-body">
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">BETA</span>
                        <span class="bloomberg-metric-value" id="perf-beta">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">ALPHA</span>
                        <span class="bloomberg-metric-value" id="perf-alpha">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">R-SQUARED</span>
                        <span class="bloomberg-metric-value" id="perf-r-squared">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">TREYNOR RATIO</span>
                        <span class="bloomberg-metric-value" id="perf-treynor">-</span>
                        </div>
                    <div class="bloomberg-metric-item">
                        <span class="bloomberg-metric-name">INFO RATIO</span>
                        <span class="bloomberg-metric-value" id="perf-info-ratio">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bloomberg Terminal Period Information -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="bloomberg-period-info">
                    <div class="bloomberg-period-header">
                        <span class="bloomberg-period-label">ANALYSIS PERIOD</span>
                        <div class="bloomberg-period-status">
                            <span class="bloomberg-period-indicator"></span>
                        </div>
                    </div>
                    <div class="bloomberg-period-content">
                        <span id="perf-period-info" class="bloomberg-period-value">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bloomberg Terminal Download Section -->
    <div id="downloadSection" class="bloomberg-download-section mt-5" style="display: none;">
        <div class="bloomberg-download-header">
            <span class="bloomberg-download-title">DATA EXPORT</span>
            <div class="bloomberg-download-status">
                <span class="bloomberg-download-indicator"></span>
                <span class="bloomberg-download-ready">READY</span>
            </div>
        </div>
        <div class="bloomberg-download-grid">
            <div class="bloomberg-download-card">
                <div class="bloomberg-download-card-header">
                    <div class="bloomberg-download-icon">📊</div>
                    <div class="bloomberg-download-card-title">CAGR MATRIX</div>
                </div>
                <div class="bloomberg-download-card-desc">
                    Complete compound annual growth rate matrix with period analysis
                </div>
                <button class="bloomberg-download-btn" id="downloadMatrix">
                    <span class="bloomberg-download-btn-text">EXPORT MATRIX</span>
                    <span class="bloomberg-download-btn-indicator">▶</span>
                </button>
            </div>
            <div class="bloomberg-download-card">
                <div class="bloomberg-download-card-header">
                    <div class="bloomberg-download-icon">📈</div>
                    <div class="bloomberg-download-card-title">RETURNS DATA</div>
                </div>
                <div class="bloomberg-download-card-desc">
                    Annual returns dataset with complete historical performance metrics
                </div>
                <button class="bloomberg-download-btn" id="downloadReturns">
                    <span class="bloomberg-download-btn-text">EXPORT DATA</span>
                    <span class="bloomberg-download-btn-indicator">▶</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bloomberg Terminal Style Footer -->
    <div class="bloomberg-footer-container mt-5">
        <div class="bloomberg-footer-divider"></div>
        <div class="bloomberg-footer-content">
            <div class="bloomberg-footer-logo-section">
                <div class="bloomberg-footer-company">
                    <span class="bloomberg-footer-company-name">PEARSON CREEK CAPITAL LLC</span>
                    <span class="bloomberg-footer-tagline">PROFESSIONAL INVESTMENT RESEARCH</span>
                </div>
            </div>
            <div class="bloomberg-footer-disclaimer">
                <div class="bloomberg-footer-warning">
                    <span class="bloomberg-footer-warning-label">DISCLAIMER</span>
                    <span class="bloomberg-footer-warning-text">
                        This analysis is for informational purposes only and does not constitute investment advice.
                        Past performance does not guarantee future results. All investments carry risk of loss.
                    </span>
                </div>
            </div>
            <div class="bloomberg-footer-tech-info">
                <div class="bloomberg-footer-timestamp" id="footerTimestamp"></div>
                <div class="bloomberg-footer-build">BUILD: ETF-ANALYZER-V2.1.0</div>
            </div>
        </div>
        <div class="bloomberg-footer-glow-line"></div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    .ticker-input-container {
        position: relative;
    }
    
    .ticker-suggestions {
        position: fixed;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 9999;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .ticker-suggestion-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .ticker-suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .ticker-suggestion-symbol {
        font-weight: bold;
        color: #1f4e79;
    }
    
    .ticker-suggestion-name {
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    .ticker-suggestion-exchange {
        color: #6c757d;
        font-size: 0.75rem;
        float: right;
    }
    
    .ticker-input-valid {
        border-color: #28a745 !important;
    }
    
    .ticker-input-invalid {
        border-color: #dc3545 !important;
    }
    
    /* BLOOMBERG TERMINAL PERFORMANCE CARD BASE */
    .performance-card {
        background: var(--terminal-dark);
        border: 1px solid var(--terminal-border);
        border-radius: 0;
        padding: 30px 25px 25px 25px;
        height: 100%;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        transition: all 0.2s ease;
        position: relative;
        overflow: visible;
    }
    
    /* NEW BLOOMBERG METRIC CARDS - GUARANTEED TO WORK */
    .performance-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
        .performance-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .bloomberg-metric-card {
        background: #0a0a0a;
        border: 2px solid #ff6600;
        padding: 0;
        position: relative;
        box-shadow: 
            0 0 20px rgba(255, 102, 0, 0.3),
            inset 0 0 20px rgba(255, 102, 0, 0.1);
        animation: terminalBoot 0.5s ease-out;
    }
    
    .bloomberg-metric-card::before {
        content: '';
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        background: linear-gradient(45deg, #ff6600, #ff3300, #ff6600);
        opacity: 0;
        z-index: -1;
        transition: opacity 0.3s ease;
    }
    
    .bloomberg-metric-card:hover::before {
        opacity: 0.5;
    }
    
    .bloomberg-card-header {
        background: #ff6600;
        color: #000;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Orbitron', monospace;
        font-weight: 900;
        letter-spacing: 2px;
        text-transform: uppercase;
        border-bottom: 2px solid #ff3300;
    }
    
    .bloomberg-card-title {
        font-size: 0.9rem;
    }
    
    .bloomberg-card-body {
        padding: 20px;
        background: #141414;
    }
    
    .bloomberg-metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #333;
    }
    
    .bloomberg-metric-item:last-child {
        border-bottom: none;
    }
    
    .bloomberg-metric-name {
        color: #b3b3b3;
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .bloomberg-metric-value {
        color: #ff6600;
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.2rem;
        font-weight: 700;
        text-shadow: 0 0 10px rgba(255, 102, 0, 0.5);
        transition: all 0.3s ease;
    }
    
    .bloomberg-metric-value:hover {
        transform: scale(1.05);
        text-shadow: 0 0 20px rgba(255, 102, 0, 0.8);
    }
    
    /* Data type specific colors */
    .bloomberg-metric-card[data-metric-type="returns"] .bloomberg-metric-value {
        color: #00ff41;
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    
    .bloomberg-metric-card[data-metric-type="risk"] .bloomberg-metric-value {
        color: #ff0040;
        text-shadow: 0 0 10px rgba(255, 0, 64, 0.5);
    }
    
    .bloomberg-metric-card[data-metric-type="adjusted"] .bloomberg-metric-value {
        color: #00b4ff;
        text-shadow: 0 0 10px rgba(0, 180, 255, 0.5);
    }
    
    .bloomberg-metric-card[data-metric-type="relative"] .bloomberg-metric-value {
        color: #cc00ff;
        text-shadow: 0 0 10px rgba(204, 0, 255, 0.5);
    }
    
    /* 🔥 NUCLEAR HEATMAP TEXT STYLING - MAXIMUM READABILITY 🔥 */
    .plotly .gtitle, 
    .plotly .annotation-text,
    .plotly text {
        font-weight: 900 !important;
        color: #ffffff !important;
        text-shadow: 
            0 0 5px rgba(0, 0, 0, 1),
            0 0 10px rgba(0, 0, 0, 0.8),
            1px 1px 2px rgba(0, 0, 0, 1) !important;
        font-family: 'JetBrains Mono', monospace !important;
    }
    
    /* Bloomberg Terminal Heatmap Text - MAXIMUM CONTRAST */
    #heatmapPlot .plotly .annotation-text,
    #heatmapPlot .plotly text,
    #heatmapPlot .annotation,
    #heatmapPlot .plotly .xtick text,
    #heatmapPlot .plotly .ytick text,
    #heatmapPlot .plotly .axis text {
        font-weight: 900 !important;
        color: #ffffff !important;
        text-shadow: 
            0 0 8px rgba(0, 0, 0, 1),
            0 0 15px rgba(0, 0, 0, 0.9),
            2px 2px 4px rgba(0, 0, 0, 1),
            -1px -1px 2px rgba(0, 0, 0, 0.8) !important;
        font-family: 'JetBrains Mono', monospace !important;
        font-size: 11px !important;
        stroke: rgba(0, 0, 0, 0.8) !important;
        stroke-width: 0.5px !important;
    }
    
    /* Heatmap Container Professional Styling */
    #heatmapContainer {
        background: linear-gradient(135deg, var(--terminal-dark) 0%, var(--terminal-black) 100%);
        border: 2px solid var(--bloomberg-orange);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 2rem 0;
        box-shadow: 
            inset 0 0 30px rgba(255, 102, 0, 0.1),
            0 0 30px rgba(255, 102, 0, 0.15),
            0 10px 40px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    #heatmapContainer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            var(--bloomberg-orange) 20%, 
            var(--data-green) 50%, 
            var(--bloomberg-orange) 80%, 
            transparent 100%);
        box-shadow: 0 0 15px var(--bloomberg-orange);
        animation: heatmapGlow 3s ease-in-out infinite;
    }
    
    @keyframes heatmapGlow {
        0%, 100% { 
            opacity: 0.6; 
            box-shadow: 0 0 15px var(--bloomberg-orange);
        }
        50% { 
            opacity: 1; 
            box-shadow: 0 0 25px var(--bloomberg-orange-bright);
        }
    }
    
    /* Heatmap Plot Specific Enhancements */
    #heatmapPlot {
        background: var(--terminal-black);
        border-radius: 4px;
        min-height: 500px;
        position: relative;
    }
    
    /* Plotly Toolbar Professional Styling */
    #heatmapPlot .modebar {
        background: rgba(255, 102, 0, 0.1) !important;
        border: 1px solid var(--bloomberg-orange) !important;
        border-radius: 4px !important;
    }
    
    #heatmapPlot .modebar-btn svg {
        fill: var(--bloomberg-orange) !important;
    }
    
    #heatmapPlot .modebar-btn:hover {
        background: rgba(255, 102, 0, 0.2) !important;
    }
    
    /* Colorbar Professional Styling */
    #heatmapPlot .colorbar {
        border: 2px solid var(--bloomberg-orange) !important;
        border-radius: 4px !important;
    }
    
    /* 🔥 MASSIVE AXIS LABELS AND TITLES - NUCLEAR VISIBILITY 🔥 */
    #heatmapPlot .plotly .xaxislayer-above text,
    #heatmapPlot .plotly .yaxislayer-above text {
        font-weight: 900 !important;
        color: var(--bloomberg-orange) !important;
        text-shadow: 0 0 15px rgba(255, 102, 0, 0.8) !important;
        font-family: 'JetBrains Mono', monospace !important;
        font-size: 14px !important;
    }
    
    /* MAIN TITLE - NUCLEAR SIZE */
    #heatmapPlot .plotly .gtitle {
        font-weight: 900 !important;
        color: var(--bloomberg-orange) !important;
        text-shadow: 0 0 20px rgba(255, 102, 0, 0.8) !important;
        font-family: 'Orbitron', monospace !important;
        font-size: 28px !important;
    }
    
    /* AXIS TITLES - PERFECTLY SIZED TWINS */
    #heatmapPlot .plotly .xtitle,
    #heatmapPlot .plotly .ytitle {
        font-weight: 900 !important;
        color: var(--bloomberg-orange) !important;
        text-shadow: 0 0 15px rgba(255, 102, 0, 0.6) !important;
        font-family: 'Orbitron', monospace !important;
        font-size: 18px !important;
    }
    
    /* Grid Lines Professional Styling */
    #heatmapPlot .plotly .gridlayer .grid {
        stroke: #333333 !important;
        stroke-width: 0.5 !important;
        opacity: 0.3 !important;
    }
    
    .performance-card:hover {
        box-shadow: 
            inset 0 0 20px rgba(0, 0, 0, 0.7),
            0 0 10px rgba(255, 102, 0, 0.1);
    }
    
    .performance-card-header {
        color: var(--bloomberg-orange);
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--terminal-border);
        font-family: 'Orbitron', monospace;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.9rem;
    }
    
    .performance-metrics {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 102, 0, 0.1);
        transition: all 0.2s ease;
    }
    
    .metric-row:hover {
        background: rgba(255, 102, 0, 0.05);
        padding-left: 10px;
        padding-right: 10px;
        margin-left: -10px;
        margin-right: -10px;
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        font-weight: 400;
        color: var(--text-secondary) !important;
        flex: 1;
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .metric-value {
        font-weight: 700;
        color: var(--bloomberg-orange) !important;
        text-align: right;
        font-family: 'JetBrains Mono', monospace;
        min-width: 100px;
        font-size: 1.1rem;
        letter-spacing: 1px;
        text-shadow: 0 0 8px rgba(255, 102, 0, 0.5);
    }
    
    .metric-value.positive {
        color: var(--data-green);
        text-shadow: 0 0 8px rgba(0, 255, 65, 0.6);
    }
    
    .metric-value.negative {
        color: var(--data-red);
        text-shadow: 0 0 8px rgba(255, 0, 64, 0.6);
    }
    
    .metric-value.neutral {
        color: var(--text-tertiary);
    }
    
    /* BLOOMBERG TERMINAL ANIMATIONS */
    @keyframes terminalBoot {
        0% {
            opacity: 0;
            transform: translateY(20px);
            filter: blur(5px);
        }
        50% {
            opacity: 0.5;
            filter: blur(2px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
            filter: blur(0);
        }
    }
    
    @keyframes dataStream {
        0% {
            background-position: 0 0;
        }
        100% {
            background-position: 100px 0;
        }
    }
    
    /* Apply boot animation to all cards */
    .performance-card,
    .overview-card,
    .control-panel {
        animation: terminalBoot 0.8s ease-out;
    }
    
    /* Matrix container styling */
    .matrix-container {
        background: var(--terminal-dark);
        border: 2px solid var(--bloomberg-orange-dark);
        border-radius: 0;
        padding: 20px;
        box-shadow: 
            inset 0 0 30px rgba(255, 102, 0, 0.1),
            0 0 40px rgba(255, 102, 0, 0.1);
        overflow: visible;
        position: relative;
        min-height: 700px;
    }
    
    #heatmapPlot {
        width: 100%;
        height: 100%;
        min-height: 650px;
    }
    
    /* Loading spinner Bloomberg style */
    .spinner-container {
        background: var(--terminal-black);
        padding: 50px;
        border-radius: 0;
        border: 2px solid var(--bloomberg-orange);
        animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.3);
        }
        50% {
            box-shadow: 0 0 60px rgba(255, 102, 0, 0.6);
        }
    }
    
    .spinner-border {
        border-color: var(--bloomberg-orange);
        border-right-color: transparent;
    }
    
    /* Error alert Bloomberg style */
    .alert-danger {
        background: var(--terminal-dark);
        border: 2px solid var(--data-red);
        color: var(--data-red);
        border-radius: 0;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 20px;
        box-shadow: 
            inset 0 0 20px rgba(255, 0, 64, 0.1),
            0 0 30px rgba(255, 0, 64, 0.2);
    }
    
    /* Ticker input Bloomberg style */
    #tickerInput {
        background: var(--terminal-black) !important;
        border: 1px solid var(--bloomberg-orange-dark) !important;
        color: var(--data-green) !important;
        font-family: 'JetBrains Mono', monospace !important;
        text-transform: uppercase !important;
        letter-spacing: 2px !important;
    }
    
    #tickerInput:focus {
        box-shadow: var(--glow-orange) !important;
        border-color: var(--bloomberg-orange) !important;
    }
    
    /* Download buttons Bloomberg style */
    .btn-outline-success {
        background: var(--terminal-black);
        border: 1px solid var(--data-green);
        color: var(--data-green);
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 0;
        transition: all 0.2s ease;
    }
    
    .btn-outline-success:hover {
        background: var(--data-green);
        color: var(--terminal-black);
        box-shadow: var(--glow-green);
        border-color: var(--data-green);
    }
    
    /* Terminal cursor effect */
    .terminal-cursor::after {
        content: '_';
        animation: blink 1s infinite;
        color: var(--bloomberg-orange);
        font-weight: bold;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }
    
    /* BLOOMBERG TERMINAL PERIOD INFO - PROFESSIONAL STYLING */
    .bloomberg-period-info {
        background: var(--terminal-darker);
        border: 1px solid var(--data-blue);
        border-left: 3px solid var(--data-blue);
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 
            inset 0 0 15px rgba(0, 180, 255, 0.05),
            0 0 10px rgba(0, 180, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .bloomberg-period-info:hover {
        border-color: var(--data-blue);
        box-shadow: 
            inset 0 0 20px rgba(0, 180, 255, 0.1),
            0 0 15px rgba(0, 180, 255, 0.2);
    }
    
    .bloomberg-period-header {
        background: rgba(0, 180, 255, 0.1);
        padding: 0.8rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(0, 180, 255, 0.2);
    }
    
    .bloomberg-period-label {
        font-family: 'Orbitron', monospace;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--data-blue);
        text-shadow: 0 0 8px rgba(0, 180, 255, 0.3);
        letter-spacing: 2px;
    }
    
    .bloomberg-period-status {
        display: flex;
        align-items: center;
    }
    
    .bloomberg-period-indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--data-blue);
        box-shadow: 0 0 8px var(--data-blue);
        animation: periodPulse 2s ease-in-out infinite;
    }
    
    .bloomberg-period-content {
        padding: 1rem;
    }
    
    .bloomberg-period-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        display: block;
        text-align: center;
    }
    
    @keyframes periodPulse {
        0%, 100% { 
            opacity: 1; 
            transform: scale(1);
        }
        50% { 
            opacity: 0.6; 
            transform: scale(1.3);
        }
    }
    
    /* BLOOMBERG TERMINAL DOWNLOAD SECTION - NUCLEAR STYLING */
    .bloomberg-download-section {
        background: var(--terminal-dark);
        border: 2px solid var(--bloomberg-orange-dark);
        border-radius: 8px;
        padding: 0;
        margin: 2rem 0;
        box-shadow: 
            inset 0 0 30px rgba(255, 102, 0, 0.1),
            0 0 30px rgba(255, 102, 0, 0.15);
        position: relative;
        overflow: hidden;
    }
    
    .bloomberg-download-header {
        background: linear-gradient(90deg, var(--bloomberg-orange-dark), var(--bloomberg-orange));
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--bloomberg-orange);
    }
    
    .bloomberg-download-title {
        font-family: 'Orbitron', monospace;
        font-size: 1.2rem;
        font-weight: 900;
        color: var(--terminal-black);
        letter-spacing: 3px;
        text-shadow: none;
    }
    
    .bloomberg-download-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .bloomberg-download-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--data-green);
        box-shadow: 0 0 10px var(--data-green);
        animation: downloadPulse 2s ease-in-out infinite;
    }
    
    .bloomberg-download-ready {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--terminal-black);
    }
    
    .bloomberg-download-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        padding: 2rem;
    }
    
    .bloomberg-download-card {
        background: var(--terminal-darker);
        border: 1px solid var(--terminal-border);
        border-radius: 6px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .bloomberg-download-card:hover {
        border-color: var(--bloomberg-orange);
        box-shadow: 
            inset 0 0 20px rgba(255, 102, 0, 0.1),
            0 0 20px rgba(255, 102, 0, 0.2);
        transform: translateY(-2px);
    }
    
    .bloomberg-download-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--bloomberg-orange), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .bloomberg-download-card:hover::before {
        opacity: 1;
    }
    
    .bloomberg-download-card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .bloomberg-download-icon {
        font-size: 1.5rem;
        opacity: 0.8;
    }
    
    .bloomberg-download-card-title {
        font-family: 'Orbitron', monospace;
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: 2px;
    }
    
    .bloomberg-download-card-desc {
        color: var(--text-secondary);
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        margin-bottom: 1.5rem;
    }
    
    .bloomberg-download-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--bloomberg-orange-dark), var(--bloomberg-orange));
        border: none;
        border-radius: 4px;
        padding: 0.8rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .bloomberg-download-btn:hover {
        background: linear-gradient(135deg, var(--bloomberg-orange), var(--bloomberg-orange-bright));
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4);
    }
    
    .bloomberg-download-btn:active {
        transform: translateY(0);
    }
    
    .bloomberg-download-btn-text {
        font-family: 'Orbitron', monospace;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--terminal-black);
        letter-spacing: 1px;
    }
    
    .bloomberg-download-btn-indicator {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1rem;
        color: var(--terminal-black);
        transition: transform 0.3s ease;
    }
    
    .bloomberg-download-btn:hover .bloomberg-download-btn-indicator {
        transform: translateX(3px);
    }
    
    @keyframes downloadPulse {
        0%, 100% { 
            opacity: 1; 
            transform: scale(1);
        }
        50% { 
            opacity: 0.6; 
            transform: scale(1.2);
        }
    }
    
    /* Responsive Design for Download Section */
    @media (max-width: 768px) {
        .bloomberg-download-grid {
            grid-template-columns: 1fr;
            padding: 1.5rem;
        }
        
        .bloomberg-download-header {
            padding: 0.8rem 1rem;
        }
        
        .bloomberg-download-title {
            font-size: 1rem;
            letter-spacing: 2px;
        }
    }
    
    /* BLOOMBERG TERMINAL FOOTER - NUCLEAR PROFESSIONAL STYLING */
    .bloomberg-footer-container {
        background: linear-gradient(180deg, var(--terminal-dark) 0%, var(--terminal-black) 100%);
        border-top: 2px solid var(--bloomberg-orange);
        position: relative;
        margin-top: 3rem;
        padding: 0;
        overflow: hidden;
    }
    
    .bloomberg-footer-divider {
        height: 1px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            var(--bloomberg-orange) 20%, 
            var(--bloomberg-orange-bright) 50%, 
            var(--bloomberg-orange) 80%, 
            transparent 100%);
        box-shadow: 0 0 10px var(--bloomberg-orange);
        animation: footerPulse 3s ease-in-out infinite;
    }
    
    .bloomberg-footer-content {
        padding: 2rem 1.5rem;
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 2rem;
        align-items: center;
        position: relative;
    }
    
    .bloomberg-footer-company {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .bloomberg-footer-company-name {
        font-family: 'Orbitron', monospace;
        font-size: 1.1rem;
        font-weight: 900;
        color: var(--text-primary);
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        letter-spacing: 3px;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .bloomberg-footer-tagline {
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.8rem;
        color: var(--bloomberg-orange);
        text-transform: uppercase;
        letter-spacing: 2px;
        opacity: 0.9;
    }
    
    .bloomberg-footer-disclaimer {
        text-align: center;
        padding: 0 1rem;
    }
    
    .bloomberg-footer-warning {
        background: rgba(255, 102, 0, 0.05);
        border: 1px solid rgba(255, 102, 0, 0.2);
        border-radius: 4px;
        padding: 1rem;
        position: relative;
    }
    
    .bloomberg-footer-warning-label {
        position: absolute;
        top: -8px;
        left: 12px;
        background: var(--terminal-dark);
        color: var(--bloomberg-orange);
        font-family: 'Orbitron', monospace;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 2px 8px;
        border: 1px solid var(--bloomberg-orange);
        letter-spacing: 1px;
    }
    
    .bloomberg-footer-warning-text {
        color: var(--text-secondary);
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.8rem;
        line-height: 1.4;
        display: block;
        margin-top: 0.5rem;
    }
    
    .bloomberg-footer-tech-info {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }
    
    .bloomberg-footer-timestamp {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        color: var(--data-green);
        text-shadow: 0 0 8px rgba(0, 255, 65, 0.4);
    }
    
    .bloomberg-footer-build {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        color: var(--text-tertiary);
        opacity: 0.7;
    }
    
    .bloomberg-footer-glow-line {
        height: 2px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            var(--bloomberg-orange) 30%, 
            var(--data-green) 70%, 
            transparent 100%);
        box-shadow: 0 0 8px var(--bloomberg-orange);
    }
    
    @keyframes footerPulse {
        0%, 100% { 
            box-shadow: 0 0 10px var(--bloomberg-orange);
            opacity: 1; 
        }
        50% { 
            box-shadow: 0 0 20px var(--bloomberg-orange-bright);
            opacity: 0.8; 
        }
    }
    
    /* Responsive Design */
    @media (max-width: 992px) {
        .bloomberg-footer-content {
            grid-template-columns: 1fr;
            text-align: center;
            gap: 1.5rem;
        }
        
        .bloomberg-footer-company {
            align-items: center;
        }
        
        .bloomberg-footer-tech-info {
            align-items: center;
        }
    }
    
    @media (max-width: 576px) {
        .bloomberg-footer-content {
            padding: 1.5rem 1rem;
        }
        
        .bloomberg-footer-company-name {
            font-size: 0.9rem;
            letter-spacing: 2px;
        }
        
        .bloomberg-footer-warning-text {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Time period configurations
    const timePeriods = {{ time_periods|safe }};
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize footer timestamp
        function updateFooterTimestamp() {
            const now = new Date();
            const timestamp = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
            const footerTimestamp = document.getElementById('footerTimestamp');
            if (footerTimestamp) {
                footerTimestamp.textContent = `LAST UPDATE: ${timestamp}`;
            }
        }
        
        // Update timestamp immediately and every minute
        updateFooterTimestamp();
        setInterval(updateFooterTimestamp, 60000);
        
        const periodSelect = document.getElementById('periodSelect');
        const startYearInput = document.getElementById('startYear');
        const endYearInput = document.getElementById('endYear');
        
        // Handle period selection change
        periodSelect.addEventListener('change', function() {
            const selectedPeriod = this.value;
            const periodConfig = timePeriods[selectedPeriod];
            
            if (selectedPeriod === 'Custom') {
                // For custom period, enable inputs so user can change them
                startYearInput.disabled = false;
                endYearInput.disabled = false;
            } else {
                // For predefined periods, disable inputs and set values
                startYearInput.disabled = true;
                endYearInput.disabled = true;
                
                if (selectedPeriod === 'Full Period') {
                    // Use ticker's actual date range if available
                    if (tickerDateRange && isValidTicker) {
                        startYearInput.value = tickerDateRange.start_year;
                        endYearInput.value = tickerDateRange.end_year;
                    } else {
                        // Fallback to default range if no ticker data available
                        startYearInput.value = 2000;
                        endYearInput.value = new Date().getFullYear();
                    }
                } else if (selectedPeriod !== 'Full Period') {
                    startYearInput.value = periodConfig.start;
                    endYearInput.value = periodConfig.end;
                }
            }
        });
        
        // Initial setup
        periodSelect.dispatchEvent(new Event('change'));
        
        // Update button click
        document.getElementById('updateButton').addEventListener('click', function() {
            updateAnalysis();
        });
        
        // Download buttons
        document.getElementById('downloadMatrix').addEventListener('click', downloadMatrix);
        document.getElementById('downloadReturns').addEventListener('click', downloadReturns);
        
        // Analysis Mode Toggle Handlers
        document.getElementById('singleModeRadio').addEventListener('change', function() {
            if (this.checked) {
                switchToSingleMode();
            }
        });
        
        document.getElementById('comparativeModeRadio').addEventListener('change', function() {
            if (this.checked) {
                switchToComparativeMode();
            }
        });
        
        // Matrix type toggle handlers
        document.getElementById('cagrRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'CAGR shows annualized returns between periods';
                updateStatisticLabels('CAGR');
                // Auto-update if we have valid data
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('totalReturnRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Total Return shows cumulative returns between periods';
                updateStatisticLabels('Total Return');
                // Auto-update if we have valid data
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('simpleAnnualizedRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Simple Annualized Return shows average annual returns without compounding';
                updateStatisticLabels('Simple Annualized Return');
                // Auto-update if we have valid data
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        // Comparative Analysis Matrix Type Handlers
        // Difference Matrix Types
        document.getElementById('cagrDifferenceRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'CAGR Difference shows how much the primary ticker outperformed the benchmark (positive = outperformance)';
                updateStatisticLabels('CAGR Difference');
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('totalReturnDifferenceRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Total Return Difference shows cumulative outperformance vs benchmark (positive = outperformance)';
                updateStatisticLabels('Total Return Difference');
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('simpleAnnualizedDifferenceRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Simple Annualized Difference shows average annual outperformance vs benchmark';
                updateStatisticLabels('Simple Annualized Return Difference');
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        // Ratio Matrix Types
        document.getElementById('cagrRatioRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'CAGR Ratio shows relative performance vs benchmark (>1.0 = outperformance, <1.0 = underperformance)';
                updateStatisticLabels('CAGR Ratio');
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('totalReturnRatioRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Total Return Ratio shows cumulative relative performance vs benchmark (>1.0 = outperformance)';
                updateStatisticLabels('Total Return Ratio');
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('simpleAnnualizedRatioRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Simple Annualized Ratio shows average annual relative performance vs benchmark';
                updateStatisticLabels('Simple Annualized Return Ratio');
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        // Add event listeners for comparative mode validate buttons
        // Primary ticker validation in comparative mode
        const validateTicker2Button = document.getElementById('validateTicker2');
        const tickerInput2 = document.getElementById('tickerInput2');
        const tickerInfo2 = document.getElementById('tickerInfo2');
        const tickerError2 = document.getElementById('tickerError2');
        
        validateTicker2Button.addEventListener('click', function() {
            const ticker = tickerInput2.value.trim().toUpperCase();
            if (!ticker) {
                tickerError2.textContent = 'Please enter a ticker symbol';
                tickerError2.style.display = 'block';
                tickerInput2.classList.add('ticker-input-invalid');
                return;
            }
            
            tickerInfo2.textContent = 'Validating...';
            tickerError2.style.display = 'none';
            
            fetch('/api/validate-ticker/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    tickerInput2.classList.remove('ticker-input-invalid');
                    tickerInput2.classList.add('ticker-input-valid');
                    tickerError2.style.display = 'none';
                    
                    let infoText = '';
                    if (data.info && data.info.name) {
                        infoText = `<small class="text-success">✓ ${data.info.name} (${data.info.exchange})`;
                    } else {
                        infoText = '<small class="text-success">✓ Valid ticker';
                    }
                    
                    if (data.date_range) {
                        infoText += ` • Available: ${data.date_range.start_year}-${data.date_range.end_year}`;
                    }
                    infoText += '</small>';
                    
                    tickerInfo2.innerHTML = infoText;
                } else {
                    tickerInput2.classList.add('ticker-input-invalid');
                    tickerInput2.classList.remove('ticker-input-valid');
                    tickerError2.textContent = data.error || 'Invalid ticker symbol';
                    tickerError2.style.display = 'block';
                    tickerInfo2.textContent = '';
                }
            })
            .catch(error => {
                tickerError2.textContent = 'Error validating ticker';
                tickerError2.style.display = 'block';
                tickerInfo2.textContent = '';
            });
        });
        
        // Benchmark ticker validation
        const validateBenchmarkButton = document.getElementById('validateBenchmarkTicker');
        const benchmarkTickerError = document.getElementById('benchmarkTickerError');
        const benchmarkTickerInfo = document.getElementById('benchmarkTickerInfo');
        
        validateBenchmarkButton.addEventListener('click', function() {
            const ticker = benchmarkTickerInput.value.trim().toUpperCase();
            if (!ticker) {
                benchmarkTickerError.textContent = 'Please enter a ticker symbol';
                benchmarkTickerError.style.display = 'block';
                benchmarkTickerInput.classList.add('ticker-input-invalid');
                return;
            }
            
            benchmarkTickerInfo.textContent = 'Validating...';
            benchmarkTickerError.style.display = 'none';
            
            fetch('/api/validate-ticker/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    benchmarkTickerInput.classList.remove('ticker-input-invalid');
                    benchmarkTickerInput.classList.add('ticker-input-valid');
                    benchmarkTickerError.style.display = 'none';
                    
                    let infoText = '';
                    if (data.info && data.info.name) {
                        infoText = `<small class="text-success">✓ ${data.info.name} (${data.info.exchange})`;
                    } else {
                        infoText = '<small class="text-success">✓ Valid ticker';
                    }
                    
                    if (data.date_range) {
                        infoText += ` • Available: ${data.date_range.start_year}-${data.date_range.end_year}`;
                    }
                    infoText += '</small>';
                    
                    benchmarkTickerInfo.innerHTML = infoText;
                } else {
                    benchmarkTickerInput.classList.add('ticker-input-invalid');
                    benchmarkTickerInput.classList.remove('ticker-input-valid');
                    benchmarkTickerError.textContent = data.error || 'Invalid ticker symbol';
                    benchmarkTickerError.style.display = 'block';
                    benchmarkTickerInfo.textContent = '';
                }
            })
            .catch(error => {
                benchmarkTickerError.textContent = 'Error validating ticker';
                benchmarkTickerError.style.display = 'block';
                benchmarkTickerInfo.textContent = '';
            });
        });
        
        // Add Enter key support for comparative mode inputs
        tickerInput2.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateTicker2Button.click();
            }
        });
        
        benchmarkTickerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateBenchmarkButton.click();
            }
        });
        
        // Clear validation when typing
        tickerInput2.addEventListener('input', function() {
            tickerInput2.classList.remove('ticker-input-valid', 'ticker-input-invalid');
            tickerError2.style.display = 'none';
            tickerInfo2.textContent = '';
        });
        
        benchmarkTickerInput.addEventListener('input', function() {
            benchmarkTickerInput.classList.remove('ticker-input-valid', 'ticker-input-invalid');
            benchmarkTickerError.style.display = 'none';
            benchmarkTickerInfo.textContent = '';
        });
        
        // Validate initial ticker and load data
        validateTicker();
        setTimeout(function() {
            if (isValidTicker) {
                updateAnalysis();
            }
        }, 1000);
    });
    
    function updateStatisticLabels(matrixType) {
        // Update the instructions based on matrix type
        const instructionsContainer = document.getElementById('instructions');
        if (instructionsContainer) {
            const cellDescription = instructionsContainer.querySelector('li:nth-child(3)');
            if (cellDescription) {
                if (matrixType === 'Total Return') {
                    cellDescription.innerHTML = '<strong>Cell Values:</strong> Total Return percentage for that specific time period';
                } else if (matrixType === 'Simple Annualized Return') {
                    cellDescription.innerHTML = '<strong>Cell Values:</strong> Simple Annualized Return percentage for that specific time period';
                } else {
                    cellDescription.innerHTML = '<strong>Cell Values:</strong> Compound Annual Growth Rate (CAGR) for that specific time period';
                }
            }
        }
        
        // Update statistic labels if data is already displayed
        if (document.getElementById('statsContainer').style.display !== 'none') {
            const bestYearElement = document.getElementById('bestSingleYearLabel');
            const worstYearElement = document.getElementById('worstSingleYearLabel');
            const tenYearElement = document.getElementById('tenYearCAGRLabel');
            const fullPeriodElement = document.getElementById('fullPeriodCAGRLabel');
            
            if (bestYearElement && bestYearElement.textContent.includes('(')) {
                const year = bestYearElement.textContent.match(/\((\d{4})\)/)[1];
                bestYearElement.textContent = `Best Single Year ${matrixType} (${year})`;
            }
            
            if (worstYearElement && worstYearElement.textContent.includes('(')) {
                const year = worstYearElement.textContent.match(/\((\d{4})\)/)[1];
                worstYearElement.textContent = `Worst Single Year ${matrixType} (${year})`;
            }
            
            if (tenYearElement && tenYearElement.textContent.includes('10-Year')) {
                const yearMatch = tenYearElement.textContent.match(/\((\d{4}-\d{4})\)/);
                if (yearMatch) {
                    tenYearElement.textContent = `10-Year ${matrixType} (${yearMatch[1]})`;
                } else {
                    tenYearElement.textContent = `10-Year ${matrixType}`;
                }
            }
            
            if (fullPeriodElement && fullPeriodElement.textContent.includes('-Year')) {
                const yearMatch = fullPeriodElement.textContent.match(/(\d+)-Year/);
                const periodMatch = fullPeriodElement.textContent.match(/\((\d{4}-\d{4})\)/);
                if (yearMatch && periodMatch) {
                    fullPeriodElement.textContent = `${yearMatch[1]}-Year ${matrixType} (${periodMatch[1]})`;
                }
            }
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    let currentTicker = 'SPY';
    let isValidTicker = true;
    let tickerDateRange = null; // Store the available date range for the current ticker
    
    // Ticker input handling
    const tickerInput = document.getElementById('tickerInput');
    const tickerSuggestions = document.getElementById('tickerSuggestions');
    const tickerInfo = document.getElementById('tickerInfo');
    const tickerError = document.getElementById('tickerError');
    const validateButton = document.getElementById('validateTicker');
    
    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Search for tickers
    const searchTickers = debounce(function(query) {
        if (query.length < 1) {
            tickerSuggestions.style.display = 'none';
            return;
        }
        
        fetch(`/api/search-tickers/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    tickerSuggestions.innerHTML = '';
                    data.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'ticker-suggestion-item';
                        div.innerHTML = `
                            <span class="ticker-suggestion-symbol">${item.symbol}</span>
                            <span class="ticker-suggestion-exchange">${item.exchange}</span><br>
                            <span class="ticker-suggestion-name">${item.name}</span>
                        `;
                        div.addEventListener('click', function() {
                            tickerInput.value = item.symbol;
                            tickerSuggestions.style.display = 'none';
                            validateTicker();
                        });
                        tickerSuggestions.appendChild(div);
                    });
                    
                    // Position the suggestions below the input field
                    const inputRect = tickerInput.getBoundingClientRect();
                    tickerSuggestions.style.top = (inputRect.bottom + window.scrollY) + 'px';
                    tickerSuggestions.style.left = inputRect.left + 'px';
                    tickerSuggestions.style.width = inputRect.width + 'px';
                    
                    tickerSuggestions.style.display = 'block';
                } else {
                    tickerSuggestions.style.display = 'none';
                }
            });
    }, 300);
    
    // Ticker input events
    tickerInput.addEventListener('input', function() {
        searchTickers(this.value);
        tickerInput.classList.remove('ticker-input-valid', 'ticker-input-invalid');
        tickerError.style.display = 'none';
        tickerInfo.textContent = '';
    });
    
    // Function to position suggestions
    function positionSuggestions() {
        if (tickerSuggestions.style.display === 'block') {
            const inputRect = tickerInput.getBoundingClientRect();
            tickerSuggestions.style.top = (inputRect.bottom + window.scrollY) + 'px';
            tickerSuggestions.style.left = inputRect.left + 'px';
            tickerSuggestions.style.width = inputRect.width + 'px';
        }
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!tickerInput.contains(e.target) && !tickerSuggestions.contains(e.target)) {
            tickerSuggestions.style.display = 'none';
        }
    });
    
    // Reposition suggestions on window resize or scroll
    window.addEventListener('resize', positionSuggestions);
    window.addEventListener('scroll', positionSuggestions);
    
    // Validate ticker
    function validateTicker() {
        const ticker = tickerInput.value.trim().toUpperCase();
        if (!ticker) {
            tickerError.textContent = 'Please enter a ticker symbol';
            tickerError.style.display = 'block';
            tickerInput.classList.add('ticker-input-invalid');
            isValidTicker = false;
            return;
        }
        
        tickerInfo.textContent = 'Validating...';
        tickerError.style.display = 'none';
        
        fetch('/api/validate-ticker/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                currentTicker = data.ticker;
                isValidTicker = true;
                tickerDateRange = data.date_range || null; // Store the available date range
                tickerInput.classList.remove('ticker-input-invalid');
                tickerInput.classList.add('ticker-input-valid');
                tickerError.style.display = 'none';
                
                let infoText = '';
                if (data.info && data.info.name) {
                    infoText = `<small class="text-success">✓ ${data.info.name} (${data.info.exchange})`;
                } else {
                    infoText = '<small class="text-success">✓ Valid ticker';
                }
                
                // Add date range info if available
                if (tickerDateRange) {
                    infoText += ` • Available: ${tickerDateRange.start_year}-${tickerDateRange.end_year}`;
                }
                infoText += '</small>';
                
                tickerInfo.innerHTML = infoText;
                
                // Update the relative performance title with the new ticker
                updateRelativePerformanceTitle(ticker.trim().toUpperCase());
                
                // Update Full Period option if it's currently selected
                if (document.getElementById('periodSelect').value === 'Full Period' && tickerDateRange) {
                    document.getElementById('startYear').value = tickerDateRange.start_year;
                    document.getElementById('endYear').value = tickerDateRange.end_year;
                }
            } else {
                isValidTicker = false;
                tickerDateRange = null;
                tickerInput.classList.remove('ticker-input-valid');
                tickerInput.classList.add('ticker-input-invalid');
                tickerError.textContent = data.error || 'Invalid ticker symbol';
                tickerError.style.display = 'block';
                tickerInfo.textContent = '';
            }
        })
        .catch(error => {
            isValidTicker = false;
            tickerError.textContent = 'Error validating ticker';
            tickerError.style.display = 'block';
            tickerInfo.textContent = '';
        });
    }
    
    validateButton.addEventListener('click', validateTicker);
    
    // Enter key to validate
    tickerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            validateTicker();
        }
    });
    
    // Update title when benchmark ticker changes
    const benchmarkTickerInput = document.getElementById('benchmarkTickerInput');
    if (benchmarkTickerInput) {
        benchmarkTickerInput.addEventListener('input', function() {
            const primaryTicker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (primaryTicker) {
                updateRelativePerformanceTitle(primaryTicker);
            }
        });
    }
    
    // Update Relative Performance Title Function
    function updateRelativePerformanceTitle(primaryTicker) {
        const analysisMode = document.querySelector('input[name="analysisMode"]:checked').value;
        const titleElement = document.getElementById('relative-performance-title');
        
        if (analysisMode === 'Single') {
            // For single mode, show "{TICKER} vs S&P 500"
            titleElement.textContent = `${primaryTicker} vs S&P 500`;
        } else {
            // For comparative mode, show "{PRIMARY} vs {BENCHMARK}"
            const benchmarkTicker = document.getElementById('benchmarkTickerInput').value.trim().toUpperCase();
            if (benchmarkTicker) {
                titleElement.textContent = `${primaryTicker} vs ${benchmarkTicker}`;
            } else {
                titleElement.textContent = `${primaryTicker} vs Benchmark`;
            }
        }
    }
    
    // Performance Overview Update Function
    function updatePerformanceOverview(performanceData, ticker, startYear, endYear) {
        // Check if performanceData exists and has the required structure
        if (!performanceData || typeof performanceData !== 'object') {
            console.error('Performance data is null or invalid:', performanceData);
            return;
        }
        
        const formatPercent = (value, decimals = 2) => {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            return (value * 100).toFixed(decimals) + '%';
        };
        
        const formatNumber = (value, decimals = 2) => {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            return value.toFixed(decimals);
        };
        
        const formatDays = (days) => {
            if (days === null || days === undefined) return 'N/A';
            if (days > 365) return `${Math.round(days / 365)} years`;
            return `${days} days`;
        };
        
        const addColorClass = (element, value, positiveGood = true) => {
            element.classList.remove('positive', 'negative', 'neutral');
            if (value === null || value === undefined || isNaN(value)) {
                element.classList.add('neutral');
            } else if ((value > 0 && positiveGood) || (value < 0 && !positiveGood)) {
                element.classList.add('positive');
            } else if ((value < 0 && positiveGood) || (value > 0 && !positiveGood)) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        };
        
        // Return Metrics
        if (performanceData.return_metrics) {
            console.log('Updating return metrics:', performanceData.return_metrics);
            const perfCagr = document.getElementById('perf-cagr');
            const perfTotalReturn = document.getElementById('perf-total-return');
            const perfBestYear = document.getElementById('perf-best-year');
            const perfWorstYear = document.getElementById('perf-worst-year');
            const perfWinRate = document.getElementById('perf-win-rate');
            
            if (!perfCagr) {
                console.error('Could not find perf-cagr element!');
                return;
            }
            
            console.log('Setting CAGR value:', formatPercent(performanceData.return_metrics.cagr));
            perfCagr.textContent = formatPercent(performanceData.return_metrics.cagr);
            perfCagr.style.color = '#00ff41';  // Use direct color
            perfCagr.style.textShadow = '0 0 8px rgba(0, 255, 65, 0.6)';
            perfCagr.style.display = 'block';
            perfCagr.style.visibility = 'visible';
            
            perfTotalReturn.textContent = formatPercent(performanceData.return_metrics.total_return);
            perfTotalReturn.style.color = '#00ff41';
            perfTotalReturn.style.display = 'block';
            perfTotalReturn.style.visibility = 'visible';
            
            const perfSimpleAnnualized = document.getElementById('perf-simple-annualized');
            if (perfSimpleAnnualized && performanceData.return_metrics.simple_annualized !== undefined && performanceData.return_metrics.simple_annualized !== null) {
                perfSimpleAnnualized.textContent = formatPercent(performanceData.return_metrics.simple_annualized);
                perfSimpleAnnualized.style.color = '#00ff41';
                perfSimpleAnnualized.style.display = 'block';
                perfSimpleAnnualized.style.visibility = 'visible';
            }
            
            perfBestYear.textContent = `${formatPercent(performanceData.return_metrics.best_year)} (${performanceData.return_metrics.best_year_date})`;
            perfBestYear.style.color = '#00ff41';
            perfBestYear.style.display = 'block';
            perfBestYear.style.visibility = 'visible';
            
            perfWorstYear.textContent = `${formatPercent(performanceData.return_metrics.worst_year)} (${performanceData.return_metrics.worst_year_date})`;
            perfWorstYear.style.color = '#ff0040';
            perfWorstYear.style.display = 'block';
            perfWorstYear.style.visibility = 'visible';
            
            perfWinRate.textContent = formatPercent(performanceData.return_metrics.win_rate);
            perfWinRate.style.color = '#00ff41';
            perfWinRate.style.display = 'block';
            perfWinRate.style.visibility = 'visible';
            
            // Skip addColorClass since we're setting colors directly
            // addColorClass(perfCagr, performanceData.return_metrics.cagr);
            // addColorClass(perfTotalReturn, performanceData.return_metrics.total_return);
            // addColorClass(perfBestYear, performanceData.return_metrics.best_year);
            // addColorClass(perfWorstYear, performanceData.return_metrics.worst_year, false);
            // addColorClass(perfWinRate, performanceData.return_metrics.win_rate);
        } else {
            console.error('No return_metrics in performance data!');
        }
        
        
        // Risk Metrics
        if (performanceData.risk_metrics) {
            const perfVolatility = document.getElementById('perf-volatility');
            const perfMaxDD = document.getElementById('perf-max-dd');
            const perfRecovery = document.getElementById('perf-recovery');
            const perfVar = document.getElementById('perf-var');
            const perfPain = document.getElementById('perf-pain');
            
            perfVolatility.textContent = formatPercent(performanceData.risk_metrics.volatility);
            perfVolatility.style.color = '#ff6600';
            perfVolatility.style.display = 'block';
            perfVolatility.style.visibility = 'visible';
            
            perfMaxDD.textContent = formatPercent(performanceData.risk_metrics.maximum_drawdown);
            perfMaxDD.style.color = '#ff0040';
            perfMaxDD.style.display = 'block';
            perfMaxDD.style.visibility = 'visible';
            
            perfRecovery.textContent = formatDays(performanceData.risk_metrics.recovery_days);
            perfRecovery.style.color = '#ff6600';
            perfRecovery.style.display = 'block';
            perfRecovery.style.visibility = 'visible';
            
            perfVar.textContent = formatPercent(performanceData.risk_metrics.var_5);
            perfVar.style.color = '#ff0040';
            perfVar.style.display = 'block';
            perfVar.style.visibility = 'visible';
            
            perfPain.textContent = formatPercent(performanceData.risk_metrics.pain_index);
            perfPain.style.color = '#ff0040';
            perfPain.style.display = 'block';
            perfPain.style.visibility = 'visible';
        }
        
        // Risk-Adjusted Metrics
        if (performanceData.risk_adjusted_metrics) {
            const perfSharpe = document.getElementById('perf-sharpe');
            const perfSortino = document.getElementById('perf-sortino');
            const perfCalmar = document.getElementById('perf-calmar');
            
            perfSharpe.textContent = formatNumber(performanceData.risk_adjusted_metrics.sharpe_ratio);
            perfSharpe.style.color = '#00b4ff';
            perfSharpe.style.display = 'block';
            perfSharpe.style.visibility = 'visible';
            
            perfSortino.textContent = formatNumber(performanceData.risk_adjusted_metrics.sortino_ratio);
            perfSortino.style.color = '#00b4ff';
            perfSortino.style.display = 'block';
            perfSortino.style.visibility = 'visible';
            
            perfCalmar.textContent = formatNumber(performanceData.risk_adjusted_metrics.calmar_ratio);
            perfCalmar.style.color = '#00b4ff';
            perfCalmar.style.display = 'block';
            perfCalmar.style.visibility = 'visible';
        }
        
        // Relative Metrics
        if (performanceData.relative_metrics) {
            const perfBeta = document.getElementById('perf-beta');
            const perfAlpha = document.getElementById('perf-alpha');
            const perfRSquared = document.getElementById('perf-r-squared');
            const perfTreynor = document.getElementById('perf-treynor');
            const perfInfoRatio = document.getElementById('perf-info-ratio');
            
            perfBeta.textContent = formatNumber(performanceData.relative_metrics.beta);
            perfBeta.style.color = '#cc00ff';
            perfBeta.style.display = 'block';
            perfBeta.style.visibility = 'visible';
            
            perfAlpha.textContent = formatPercent(performanceData.relative_metrics.alpha);
            perfAlpha.style.color = performanceData.relative_metrics.alpha > 0 ? '#00ff41' : '#ff0040';
            perfAlpha.style.display = 'block';
            perfAlpha.style.visibility = 'visible';
            
            perfRSquared.textContent = formatNumber(performanceData.relative_metrics.r_squared);
            perfRSquared.style.color = '#cc00ff';
            perfRSquared.style.display = 'block';
            perfRSquared.style.visibility = 'visible';
            
            perfTreynor.textContent = formatNumber(performanceData.relative_metrics.treynor_ratio);
            perfTreynor.style.color = '#cc00ff';
            perfTreynor.style.display = 'block';
            perfTreynor.style.visibility = 'visible';
            
            perfInfoRatio.textContent = formatNumber(performanceData.relative_metrics.information_ratio);
            perfInfoRatio.style.color = performanceData.relative_metrics.information_ratio > 0 ? '#00ff41' : '#ff0040';
            perfInfoRatio.style.display = 'block';
            perfInfoRatio.style.visibility = 'visible';
        }
        
        // Period Information
        if (performanceData.period_info) {
            const perfPeriodInfo = document.getElementById('perf-period-info');
            perfPeriodInfo.textContent = `${ticker} from ${startYear} to ${endYear} (${performanceData.period_info.num_years.toFixed(1)} years, ${performanceData.period_info.num_observations} observations)`;
        }
        
        // Update the relative performance title based on analysis mode
        updateRelativePerformanceTitle(ticker);
    }
    
    function switchToSingleMode() {
        // Update UI for single mode
        document.getElementById('analysisModeDescription').textContent = 'Analyze a single ticker\'s performance over time';
        
        // Show single mode controls, hide comparative mode controls
        document.getElementById('singleModeControls').style.display = '';
        document.getElementById('comparativeModeControls').style.display = 'none';
        
        // Show/hide matrix types and formulas
        document.getElementById('singleMatrixTypes').style.display = 'block';
        document.getElementById('comparativeMatrixTypes').style.display = 'none';
        document.getElementById('singleFormulas').style.display = 'grid';
        document.getElementById('comparativeFormulas').style.display = 'none';
        
        // Reset to CAGR as default for single mode
        document.getElementById('cagrRadio').checked = true;
        document.getElementById('matrixTypeDescription').textContent = 'CAGR shows annualized returns between periods';
        
        // Clear any comparative selections
        document.querySelectorAll('#comparativeMatrixTypes input[type="radio"]').forEach(radio => {
            radio.checked = false;
        });
        
        // Update title for single mode
        const currentTicker = document.getElementById('tickerInput').value.trim().toUpperCase();
        if (currentTicker) {
            updateRelativePerformanceTitle(currentTicker);
        }
        
        // Auto-update if we have valid data
        if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
            updateAnalysis();
        }
    }
    
    function switchToComparativeMode() {
        // Update UI for comparative mode
        document.getElementById('analysisModeDescription').textContent = 'Compare two tickers to analyze relative performance';
        
        // Hide single mode controls, show comparative mode controls
        document.getElementById('singleModeControls').style.display = 'none';
        document.getElementById('comparativeModeControls').style.display = 'block';
        
        // Sync values from single mode to comparative mode
        syncControlValues();
        
        // Show/hide matrix types and formulas
        document.getElementById('singleMatrixTypes').style.display = 'none';
        document.getElementById('comparativeMatrixTypes').style.display = 'block';
        document.getElementById('singleFormulas').style.display = 'none';
        document.getElementById('comparativeFormulas').style.display = 'grid';
        
        // Reset to CAGR Difference as default for comparative mode
        document.getElementById('cagrDifferenceRadio').checked = true;
        document.getElementById('matrixTypeDescription').textContent = 'CAGR Difference shows how much the primary ticker outperformed the benchmark (positive = outperformance)';
        
        // Clear any single mode selections
        document.querySelectorAll('#singleMatrixTypes input[type="radio"]').forEach(radio => {
            radio.checked = false;
        });
        
        // Update title for comparative mode
        const currentTicker = document.getElementById('tickerInput').value.trim().toUpperCase();
        if (currentTicker) {
            updateRelativePerformanceTitle(currentTicker);
        }
        
        // Auto-update if we have valid data
        if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
            updateAnalysis();
        }
    }
    
    function syncControlValues() {
        // Sync values from single mode to comparative mode
        document.getElementById('tickerInput2').value = document.getElementById('tickerInput').value;
        document.getElementById('periodSelect2').value = document.getElementById('periodSelect').value;
        document.getElementById('startYear2').value = document.getElementById('startYear').value;
        document.getElementById('endYear2').value = document.getElementById('endYear').value;
    }
    
    function updateAnalysis() {
        // Get values from the active control set
        const analysisMode = document.querySelector('input[name="analysisMode"]:checked').value;
        const isComparative = analysisMode === 'Comparative';
        
        // Read from appropriate inputs based on mode
        const ticker = isComparative ? 
            document.getElementById('tickerInput2').value.trim().toUpperCase() :
            document.getElementById('tickerInput').value.trim().toUpperCase();
        const period = isComparative ? 
            document.getElementById('periodSelect2').value :
            document.getElementById('periodSelect').value;
        const startYear = isComparative ? 
            document.getElementById('startYear2').value :
            document.getElementById('startYear').value;
        const endYear = isComparative ? 
            document.getElementById('endYear2').value :
            document.getElementById('endYear').value;
        

        
        if (!ticker) {
            tickerError.textContent = 'Please enter a ticker symbol';
            tickerError.style.display = 'block';
            return;
        }
        
        if (!isValidTicker) {
            tickerError.textContent = 'Please validate the ticker symbol first';
            tickerError.style.display = 'block';
            return;
        }
        
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('heatmapContainer').style.display = 'none';
        document.getElementById('instructions').style.display = 'none';
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('performanceContainer').style.display = 'none';
        document.getElementById('downloadSection').style.display = 'none';
        
        // Get selected matrix type
        const matrixType = document.querySelector('input[name="matrixType"]:checked').value;
        
        // Get benchmark ticker if in comparative mode
        let benchmarkTicker = null;
        if (isComparative) {
            benchmarkTicker = document.getElementById('benchmarkTickerInput').value.trim().toUpperCase();

            
            if (!benchmarkTicker) {
                document.getElementById('errorAlert').style.display = 'block';
                document.getElementById('errorAlert').textContent = 'Please enter a benchmark ticker for comparative analysis';
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }
            if (benchmarkTicker === ticker) {
                document.getElementById('errorAlert').style.display = 'block';
                document.getElementById('errorAlert').textContent = `Primary and benchmark tickers must be different (Primary: "${ticker}", Benchmark: "${benchmarkTicker}")`;
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }
        }
        
        // Prepare request data
        const requestData = {
            ticker: ticker,
            period: period,
            start_year: startYear,
            end_year: endYear,
            matrix_type: matrixType,
            analysis_mode: isComparative ? 'Comparative' : 'Single'
        };
        
        // Add benchmark ticker if in comparative mode
        if (isComparative) {
            requestData.benchmark_ticker = benchmarkTicker;
        }
        
        // Make API request
        fetch('/api/get-data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update year inputs if Full Period was selected
            if (period === 'Full Period' && data.available_years) {
                document.getElementById('startYear').value = data.available_years.min;
                document.getElementById('endYear').value = data.available_years.max;
            }
            
            // Clear any previous adjustment messages
            const existingAdjustmentAlerts = document.querySelectorAll('.alert-info.adjustment-alert');
            existingAdjustmentAlerts.forEach(alert => alert.remove());
            
            // Show adjustment message if date range was auto-adjusted
            if (data.date_adjusted && data.adjustment_message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible fade show adjustment-alert';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>📅 Date Range Adjusted:</strong> ${data.adjustment_message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.getElementById('errorAlert').parentNode.insertBefore(alertDiv, document.getElementById('errorAlert').nextSibling);
            }
            
            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
            
            // Show containers
            document.getElementById('heatmapContainer').style.display = 'block';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'flex';
            document.getElementById('performanceContainer').style.display = 'block';
            console.log('Performance container made visible');
            
            // Force check all bloomberg metric values are visible
            document.querySelectorAll('.bloomberg-metric-value').forEach(el => {
                console.log('Bloomberg metric element:', el.id, 'Text:', el.textContent);
                el.style.display = 'inline-block';
                el.style.visibility = 'visible';
                el.style.opacity = '1';
            });
            document.getElementById('downloadSection').style.display = 'block';
            
            // 🔥 NUCLEAR HEATMAP TRANSFORMATION - BLOOMBERG TERMINAL BEAST MODE 🔥
            
            // Create ultra-professional Bloomberg terminal colorscale
            const bloombergColorscale = [
                [0.0, '#ff0040'],     // Deep red for worst losses
                [0.1, '#ff1a2e'],     // Bright red
                [0.2, '#ff3d1a'],     // Red-orange
                [0.3, '#ff5500'],     // Orange-red
                [0.4, '#ff6600'],     // Bloomberg orange (neutral)
                [0.5, '#ff8533'],     // Light orange (slightly positive)
                [0.6, '#14532d'],     // Dark muted green
                [0.7, '#166534'],     // Darker green
                [0.8, '#22c55e'],     // Muted green
                [0.9, '#4ade80'],     // Soft green
                [1.0, '#a7f3d0']      // Very light green
            ];
            
            // Advanced terminal layout with professional grid and styling
            const terminalLayout = {
                ...data.heatmap.layout,
                paper_bgcolor: 'rgba(10, 10, 10, 0.95)',
                plot_bgcolor: '#0a0a0a',
                font: {
                    color: '#ffffff',
                    family: 'JetBrains Mono, monospace',
                    size: 12,
                    weight: 700
                },
                xaxis: {
                    ...data.heatmap.layout.xaxis,
                    color: '#ff6600',
                    gridcolor: '#333333',
                    gridwidth: 1,
                    linecolor: '#ff6600',
                    linewidth: 2,
                    tickfont: {
                        color: '#ff6600',
                        family: 'JetBrains Mono, monospace',
                        size: 14,
                        weight: 700
                    },
                    title: {
                        ...data.heatmap.layout.xaxis.title,
                        font: {
                            color: '#ff6600',
                            family: 'Orbitron, monospace',
                            size: 18,
                            weight: 900
                        }
                    }
                },
                yaxis: {
                    ...data.heatmap.layout.yaxis,
                    color: '#ff6600',
                    gridcolor: '#333333',
                    gridwidth: 1,
                    linecolor: '#ff6600',
                    linewidth: 2,
                    tickfont: {
                        color: '#ff6600',
                        family: 'JetBrains Mono, monospace',
                        size: 14,
                        weight: 700
                    },
                    title: {
                        ...data.heatmap.layout.yaxis.title,
                        font: {
                            color: '#ff6600',
                            family: 'Orbitron, monospace',
                            size: 18,
                            weight: 900
                        }
                    }
                },
                coloraxis: {
                    colorbar: {
                        bgcolor: 'rgba(20, 20, 20, 0.9)',
                        bordercolor: '#ff6600',
                        borderwidth: 2,
                        thickness: 20,
                        len: 0.8,
                        tickfont: {
                            color: '#ffffff',
                            family: 'JetBrains Mono, monospace',
                            size: 10,
                            weight: 700
                        },
                        title: {
                            font: {
                                color: '#ff6600',
                                family: 'Orbitron, monospace',
                                size: 12,
                                weight: 700
                            }
                        }
                    },
                    colorscale: bloombergColorscale
                },
                title: {
                    ...data.heatmap.layout.title,
                    font: {
                        color: '#ff6600',
                        family: 'Orbitron, monospace',
                        size: 28,
                        weight: 900
                    }
                }
            };
            
            // Nuclear data transformation with Bloomberg terminal colorscale
            const terminalData = data.heatmap.data.map(trace => {
                const enhancedTrace = {
                    ...trace,
                    // Override any existing colorscale with Bloomberg terminal colors
                    colorscale: bloombergColorscale,
                    // Enhanced hover template with Bloomberg styling
                    hovertemplate: '<b style="color: #ff6600; font-family: Orbitron, monospace; font-weight: 900;">PERIOD ANALYSIS</b><br>' +
                                   '<span style="color: #00ff41; font-family: JetBrains Mono, monospace; font-weight: 700;">FROM %{x} → %{y}</span><br>' +
                                   '<span style="color: #ffffff; font-family: JetBrains Mono, monospace; font-weight: 700;">CAGR: %{z:.1f}%</span>' +
                                   '<extra></extra>',
                    // Ensure text is always visible with strong contrast
                    textfont: {
                        color: '#ffffff',
                        family: 'JetBrains Mono, monospace',
                        size: 11,
                        weight: 900
                    },
                    // Add subtle border for professional grid effect
                    line: {
                        color: '#333333',
                        width: 0.5
                    }
                };
                
                // Force colorscale assignment for different trace types
                if (trace.type === 'heatmap') {
                    enhancedTrace.colorscale = bloombergColorscale;
                    enhancedTrace.showscale = true;
                }
                
                return enhancedTrace;
            });
            
            // Professional plotting configuration
            const plotConfig = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                modeBarButtonsToAdd: [{
                    name: 'Bloomberg Terminal Mode',
                    icon: {
                        width: 16,
                        height: 16,
                        path: 'M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z'
                    },
                    click: function() {
                        console.log('Bloomberg Terminal Mode Activated 🔥');
                    }
                }],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'bloomberg_terminal_heatmap',
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            };
            
            Plotly.newPlot('heatmapPlot', terminalData, terminalLayout, plotConfig)
                .then(function() {
                    // 🚀 POST-RENDER NUCLEAR TEXT ENHANCEMENT 🚀
                    setTimeout(() => {
                        // Force all heatmap text to be visible with maximum contrast
                        const heatmapTexts = document.querySelectorAll('#heatmapPlot text');
                        heatmapTexts.forEach(text => {
                            if (text) {
                                text.style.fill = '#ffffff';
                                text.style.fontWeight = '900';
                                text.style.fontFamily = 'JetBrains Mono, monospace';
                                text.style.fontSize = '11px';
                                text.style.textShadow = `
                                    0 0 8px rgba(0, 0, 0, 1),
                                    0 0 15px rgba(0, 0, 0, 0.9),
                                    2px 2px 4px rgba(0, 0, 0, 1),
                                    -1px -1px 2px rgba(0, 0, 0, 0.8)
                                `;
                                text.setAttribute('stroke', 'rgba(0, 0, 0, 0.8)');
                                text.setAttribute('stroke-width', '0.5');
                            }
                        });
                        
                        // 🔥 NUCLEAR TITLE AND AXIS LABEL RESTORATION 🔥
                        const axisTitles = document.querySelectorAll('#heatmapPlot .gtitle');
                        axisTitles.forEach(title => {
                            if (title) {
                                title.style.fill = '#ff6600';
                                title.style.fontWeight = '900';
                                title.style.fontFamily = 'Orbitron, monospace';
                                title.style.fontSize = '28px';
                                title.style.textShadow = '0 0 20px rgba(255, 102, 0, 0.8)';
                            }
                        });
                        
                        // 🎯 PERFECTLY MATCHED AXIS TITLES - TWIN PERFECTION
                        const xAxisTitles = document.querySelectorAll('#heatmapPlot .xtitle');
                        xAxisTitles.forEach(title => {
                            if (title) {
                                title.style.fill = '#ff6600';
                                title.style.fontWeight = '900';
                                title.style.fontFamily = 'Orbitron, monospace';
                                title.style.fontSize = '18px';
                                title.style.textShadow = '0 0 15px rgba(255, 102, 0, 0.6)';
                            }
                        });
                        
                        const yAxisTitles = document.querySelectorAll('#heatmapPlot .ytitle');
                        yAxisTitles.forEach(title => {
                            if (title) {
                                title.style.fill = '#ff6600';
                                title.style.fontWeight = '900';
                                title.style.fontFamily = 'Orbitron, monospace';
                                title.style.fontSize = '18px';
                                title.style.textShadow = '0 0 15px rgba(255, 102, 0, 0.6)';
                            }
                        });
                        
                        // Force colorbar text visibility
                        const colorbarTexts = document.querySelectorAll('#heatmapPlot .colorbar text');
                        colorbarTexts.forEach(text => {
                            if (text) {
                                text.style.fill = '#ffffff';
                                text.style.fontWeight = '700';
                                text.style.textShadow = '0 0 5px rgba(0, 0, 0, 1)';
                            }
                        });
                        
                        console.log('🔥 Bloomberg Terminal Heatmap: NUCLEAR TEXT + PERFECT TWIN AXIS LABELS COMPLETE! 🔥');
                    }, 100);
                });
            
            // Update statistics with Bloomberg terminal colors
            const currentMatrixType = document.querySelector('input[name="matrixType"]:checked').value;
            if (data.stats.best_single_year) {
                const bestYearEl = document.getElementById('bestSingleYear');
                bestYearEl.textContent = data.stats.best_single_year.value.toFixed(1) + '%';
                bestYearEl.style.color = 'var(--data-green)';
                bestYearEl.style.textShadow = '0 0 15px rgba(0, 255, 65, 0.6)';
                document.getElementById('bestSingleYearLabel').textContent = `Best Single Year ${currentMatrixType} (${data.stats.best_single_year.year})`;
            }
            
            if (data.stats.worst_single_year) {
                const worstYearEl = document.getElementById('worstSingleYear');
                worstYearEl.textContent = data.stats.worst_single_year.value.toFixed(1) + '%';
                worstYearEl.style.color = 'var(--data-red)';
                worstYearEl.style.textShadow = '0 0 15px rgba(255, 0, 64, 0.6)';
                document.getElementById('worstSingleYearLabel').textContent = `Worst Single Year ${currentMatrixType} (${data.stats.worst_single_year.year})`;
            }
            
            if (data.stats.ten_year_metric) {
                const tenYearEl = document.getElementById('tenYearCAGR');
                tenYearEl.textContent = data.stats.ten_year_metric.value.toFixed(1) + '%';
                if (data.stats.ten_year_metric.value > 0) {
                    tenYearEl.style.color = 'var(--data-green)';
                    tenYearEl.style.textShadow = '0 0 15px rgba(0, 255, 65, 0.6)';
                } else {
                    tenYearEl.style.color = 'var(--data-red)';
                    tenYearEl.style.textShadow = '0 0 15px rgba(255, 0, 64, 0.6)';
                }
                document.getElementById('tenYearCAGRLabel').textContent = `10-Year ${data.stats.ten_year_metric.type} (${data.stats.ten_year_metric.start}-${data.stats.ten_year_metric.end})`;
            } else {
                const currentMatrixType = document.querySelector('input[name="matrixType"]:checked').value;
                const tenYearEl = document.getElementById('tenYearCAGR');
                tenYearEl.textContent = 'N/A';
                tenYearEl.style.color = 'var(--text-tertiary)';
                document.getElementById('tenYearCAGRLabel').textContent = `10-Year ${currentMatrixType}`;
            }
            
            if (data.stats.full_period_metric) {
                const fullPeriodEl = document.getElementById('fullPeriodCAGR');
                fullPeriodEl.textContent = data.stats.full_period_metric.value.toFixed(1) + '%';
                if (data.stats.full_period_metric.value > 0) {
                    fullPeriodEl.style.color = 'var(--data-green)';
                    fullPeriodEl.style.textShadow = '0 0 15px rgba(0, 255, 65, 0.6)';
                } else {
                    fullPeriodEl.style.color = 'var(--data-red)';
                    fullPeriodEl.style.textShadow = '0 0 15px rgba(255, 0, 64, 0.6)';
                }
                document.getElementById('fullPeriodCAGRLabel').textContent = `${data.stats.full_period_metric.years}-Year ${data.stats.full_period_metric.type} (${data.stats.full_period_metric.start}-${data.stats.full_period_metric.end})`;
            }
            
            // Update performance overview
            if (data.performance_overview) {
                console.log('Performance data received:', data.performance_overview);
                updatePerformanceOverview(data.performance_overview, ticker, startYear, endYear);
            } else {
                console.error('No performance overview data received!');
            }
        })
        .catch(error => {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'block';
            document.getElementById('errorAlert').textContent = error.message;
        });
    }
    
    function downloadMatrix() {
        // Get ticker value directly from DOM to avoid caching issues
        const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        const matrixType = document.querySelector('input[name="matrixType"]:checked').value;
        const analysisMode = document.querySelector('input[name="analysisMode"]:checked').value;
        
        if (!ticker || !isValidTicker) {
            alert('Please enter and validate a ticker symbol first');
            return;
        }
        
        // Check benchmark ticker for comparative mode
        let benchmarkTicker = null;
        if (analysisMode === 'Comparative') {
            benchmarkTicker = document.getElementById('benchmarkTickerInput').value.trim().toUpperCase();

            
            if (!benchmarkTicker) {
                alert('Please enter a benchmark ticker for comparative analysis');
                return;
            }
            if (benchmarkTicker === ticker) {
                alert(`Primary and benchmark tickers must be different (Primary: "${ticker}", Benchmark: "${benchmarkTicker}")`);
                return;
            }
        }
        
        const requestData = {
            ticker: ticker,
            start_year: startYear,
            end_year: endYear,
            matrix_type: matrixType,
            analysis_mode: analysisMode
        };
        
        // Add benchmark ticker if in comparative mode
        if (analysisMode === 'Comparative') {
            requestData.benchmark_ticker = benchmarkTicker;
        }
        
        fetch('/api/download-matrix/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const matrixName = matrixType.replace(' ', '_');
            a.download = `PearsonCreek_${ticker}_${matrixName}_Matrix_${startYear}_${endYear}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    }
    
    function downloadReturns() {
        const ticker = tickerInput.value.trim().toUpperCase();
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        
        if (!ticker || !isValidTicker) {
            alert('Please enter and validate a ticker symbol first');
            return;
        }
        
        // Use current ticker for download
        const tickers = [ticker];
        
        const requestData = {
            start_year: startYear,
            end_year: endYear,
            tickers: tickers.length > 0 ? tickers : [ticker]
        };
        
        fetch('/api/download-returns/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PearsonCreek_Annual_Returns_${startYear}_${endYear}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    }
    

</script>
{% endblock %}