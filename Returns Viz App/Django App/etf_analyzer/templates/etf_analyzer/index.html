{% extends 'etf_analyzer/base.html' %}

{% block content %}
<style>
/* Custom Performance Card Styling */
.performance-card-returns {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
    border-left: 4px solid #28a745;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    transition: all 0.3s ease;
}

.performance-card-returns:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.25);
}

.performance-card-returns .performance-card-header {
    color: #1e7e34;
    background: linear-gradient(90deg, #28a745, #20c997);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.performance-card-risk {
    background: linear-gradient(135deg, #fff3e0 0%, #ffeaa7 100%);
    border-left: 4px solid #ff8c00;
    box-shadow: 0 4px 12px rgba(255, 140, 0, 0.15);
    transition: all 0.3s ease;
}

.performance-card-risk:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 140, 0, 0.25);
}

.performance-card-risk .performance-card-header {
    color: #e65100;
    background: linear-gradient(90deg, #ff8c00, #ff6b35);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.performance-card-adjusted {
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
    border-left: 4px solid #2196f3;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
    transition: all 0.3s ease;
}

.performance-card-adjusted:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.25);
}

.performance-card-adjusted .performance-card-header {
    color: #1565c0;
    background: linear-gradient(90deg, #2196f3, #1e88e5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.performance-card-relative {
    background: linear-gradient(135deg, #f3e5f5 0%, #faf4ff 100%);
    border-left: 4px solid #9c27b0;
    box-shadow: 0 4px 12px rgba(156, 39, 176, 0.15);
    transition: all 0.3s ease;
}

.performance-card-relative:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(156, 39, 176, 0.25);
}

.performance-card-relative .performance-card-header {
    color: #6a1b9a;
    background: linear-gradient(90deg, #9c27b0, #8e24aa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Enhanced metric values with better contrast */
.performance-card-returns .metric-value { color: #1e7e34; }
.performance-card-risk .metric-value { color: #e65100; }
.performance-card-adjusted .metric-value { color: #1565c0; }
.performance-card-relative .metric-value { color: #6a1b9a; }

/* Subtle background pattern */
.performance-card {
    position: relative;
    overflow: hidden;
}

.performance-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                      radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}
</style>
    <!-- Company Header -->
    <div class="company-header">
        <h1 class="company-name">PEARSON CREEK CAPITAL LLC</h1>
        <p class="company-tagline">Professional ETF Performance Analysis & Investment Research</p>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="tickerInput" class="form-label">üéØ Enter Ticker Symbol:</label>
                <div class="ticker-input-container">
                    <div class="input-group">
                        <input type="text" class="form-control" id="tickerInput" placeholder="e.g., AAPL, SPY, MSFT" 
                               value="SPY" autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="validateTicker">
                            <i class="bi bi-check-circle"></i> Validate
                        </button>
                    </div>
                    <div id="tickerSuggestions" class="ticker-suggestions" style="display: none;"></div>
                </div>
                <div class="form-text" id="tickerInfo"></div>
                <div class="invalid-feedback" id="tickerError" style="display: none;"></div>
            </div>
            
            <div class="col-md-3">
                <label for="periodSelect" class="form-label">üìÖ Time Period:</label>
                <select class="form-select" id="periodSelect">
                    {% for period, values in time_periods.items %}
                        <option value="{{ period }}" {% if forloop.first %}selected{% endif %}>{{ period }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Start Year:</label>
                <input type="number" class="form-control" id="startYear" value="2014" min="1990" max="2025">
                <div class="form-text" id="startYearDisplay">2014</div>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">End Year:</label>
                <input type="number" class="form-control" id="endYear" value="2025" min="1990" max="2025">
                <div class="form-text" id="endYearDisplay">2025</div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <button class="btn btn-primary" id="updateButton">Update Analysis</button>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <label class="form-label">üìä Matrix Type:</label>
                <div class="btn-group" role="group" id="matrixTypeToggle">
                    <input type="radio" class="btn-check" name="matrixType" id="cagrRadio" value="CAGR" checked>
                    <label class="btn btn-outline-primary" for="cagrRadio">CAGR</label>
                    
                    <input type="radio" class="btn-check" name="matrixType" id="totalReturnRadio" value="Total Return">
                    <label class="btn btn-outline-primary" for="totalReturnRadio">Total Return</label>
                </div>
                <div class="form-text" id="matrixTypeInfo">
                    <span id="matrixTypeDescription">CAGR shows annualized returns between periods</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">üìä Loading market data...</p>
    </div>
    
    <!-- Error Alert -->
    <div id="errorAlert" class="alert alert-danger" style="display: none;" role="alert"></div>
    
    <!-- Heatmap Container -->
    <div id="heatmapContainer" class="matrix-container" style="display: none;">
        <div id="heatmapPlot"></div>
    </div>
    
    <!-- Instructions -->
    <div id="instructions" class="instructions" style="display: none;">
        <h4>üìñ How to Read This Interactive Heatmap</h4>
        <ul>
            <li><strong>X-axis (From the start of):</strong> Starting year of investment period</li>
            <li><strong>Y-axis (To the end of):</strong> Ending year of investment period</li>
            <li><strong>Cell Values:</strong> Compound Annual Growth Rate (CAGR) for that specific time period</li>
            <li><strong>Color Coding:</strong> Red shades for negative returns, green shades for positive returns</li>
            <li><strong>Text Color:</strong> Dynamically adjusted (black/white) for optimal readability</li>
            <li><strong>Interactive:</strong> Hover over cells to see detailed CAGR information</li>
        </ul>
    </div>
    
    <!-- Key Statistics -->
    <div id="statsContainer" class="row g-3 mt-4" style="display: none;">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="bestSingleYear">-</div>
                <div class="stat-label" id="bestSingleYearLabel">Best Single Year</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="worstSingleYear">-</div>
                <div class="stat-label" id="worstSingleYearLabel">Worst Single Year</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="tenYearCAGR">-</div>
                <div class="stat-label" id="tenYearCAGRLabel">10-Year CAGR</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="fullPeriodCAGR">-</div>
                <div class="stat-label" id="fullPeriodCAGRLabel">Full Period CAGR</div>
            </div>
        </div>
    </div>
    
    <!-- Performance Overview -->
    <div id="performanceContainer" class="mt-5" style="display: none;">
        <h3>üìä Performance Overview</h3>
        <div class="row g-4">
            <!-- Return Metrics -->
            <div class="col-md-6">
                <div class="performance-card performance-card-returns">
                    <h5 class="performance-card-header">üìà Return Metrics</h5>
                    <div class="performance-metrics">
                        <div class="metric-row">
                            <span class="metric-label">CAGR:</span>
                            <span class="metric-value" id="perf-cagr">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Total Return:</span>
                            <span class="metric-value" id="perf-total-return">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Best Year:</span>
                            <span class="metric-value" id="perf-best-year">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Worst Year:</span>
                            <span class="metric-value" id="perf-worst-year">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Win Rate:</span>
                            <span class="metric-value" id="perf-win-rate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Metrics -->
            <div class="col-md-6">
                <div class="performance-card performance-card-risk">
                    <h5 class="performance-card-header">‚ö†Ô∏è Risk Metrics</h5>
                    <div class="performance-metrics">
                        <div class="metric-row">
                            <span class="metric-label">Volatility:</span>
                            <span class="metric-value" id="perf-volatility">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Max Drawdown:</span>
                            <span class="metric-value" id="perf-max-dd">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Recovery Days:</span>
                            <span class="metric-value" id="perf-recovery">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">VaR (5%):</span>
                            <span class="metric-value" id="perf-var">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pain Index:</span>
                            <span class="metric-value" id="perf-pain">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk-Adjusted Metrics -->
            <div class="col-md-6">
                <div class="performance-card performance-card-adjusted">
                    <h5 class="performance-card-header">‚öñÔ∏è Risk-Adjusted Returns</h5>
                    <div class="performance-metrics">
                        <div class="metric-row">
                            <span class="metric-label">Sharpe Ratio:</span>
                            <span class="metric-value" id="perf-sharpe">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Sortino Ratio:</span>
                            <span class="metric-value" id="perf-sortino">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Calmar Ratio:</span>
                            <span class="metric-value" id="perf-calmar">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relative Metrics (vs S&P 500) -->
            <div class="col-md-6">
                <div class="performance-card performance-card-relative">
                    <h5 class="performance-card-header">üìä Relative to S&P 500</h5>
                    <div class="performance-metrics">
                        <div class="metric-row">
                            <span class="metric-label">Beta:</span>
                            <span class="metric-value" id="perf-beta">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Alpha:</span>
                            <span class="metric-value" id="perf-alpha">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">R-Squared:</span>
                            <span class="metric-value" id="perf-r-squared">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Treynor Ratio:</span>
                            <span class="metric-value" id="perf-treynor">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Information Ratio:</span>
                            <span class="metric-value" id="perf-info-ratio">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Period Information -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong>Analysis Period:</strong> <span id="perf-period-info">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Download Section -->
    <div id="downloadSection" class="mt-5" style="display: none;">
        <h3>üíæ Export Analysis</h3>
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-primary" id="downloadMatrix">üì• Download CAGR Matrix</button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-primary" id="downloadReturns">üìä Download Annual Returns Data</button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <hr class="mt-5">
    <div class="text-center text-muted py-3">
        <strong>Pearson Creek Capital LLC</strong> | Professional Investment Research<br>
        <em>This analysis is for informational purposes only and does not constitute investment advice.</em>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    .ticker-input-container {
        position: relative;
    }
    
    .ticker-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .ticker-suggestion-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .ticker-suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .ticker-suggestion-symbol {
        font-weight: bold;
        color: #1f4e79;
    }
    
    .ticker-suggestion-name {
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    .ticker-suggestion-exchange {
        color: #6c757d;
        font-size: 0.75rem;
        float: right;
    }
    
    .ticker-input-valid {
        border-color: #28a745 !important;
    }
    
    .ticker-input-invalid {
        border-color: #dc3545 !important;
    }
    
    /* Performance Overview Styling */
    .performance-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        height: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease;
    }
    
    .performance-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .performance-card-header {
        color: #1f4e79;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .performance-metrics {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        font-weight: 500;
        color: #495057;
        flex: 1;
    }
    
    .metric-value {
        font-weight: 600;
        color: #212529;
        text-align: right;
        font-family: 'Courier New', monospace;
        min-width: 80px;
    }
    
    .metric-value.positive {
        color: #28a745;
    }
    
    .metric-value.negative {
        color: #dc3545;
    }
    
    .metric-value.neutral {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Time period configurations
    const timePeriods = {{ time_periods|safe }};
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        const periodSelect = document.getElementById('periodSelect');
        const startYearInput = document.getElementById('startYear');
        const endYearInput = document.getElementById('endYear');
        const startYearDisplay = document.getElementById('startYearDisplay');
        const endYearDisplay = document.getElementById('endYearDisplay');
        
        // Handle period selection change
        periodSelect.addEventListener('change', function() {
            const selectedPeriod = this.value;
            const periodConfig = timePeriods[selectedPeriod];
            
            if (selectedPeriod === 'Custom') {
                startYearInput.style.display = 'block';
                endYearInput.style.display = 'block';
                startYearDisplay.style.display = 'none';
                endYearDisplay.style.display = 'none';
            } else {
                startYearInput.style.display = 'none';
                endYearInput.style.display = 'none';
                startYearDisplay.style.display = 'block';
                endYearDisplay.style.display = 'block';
                
                if (selectedPeriod === 'Full Period') {
                    // Use ticker's actual date range if available
                    if (tickerDateRange && isValidTicker) {
                        startYearInput.value = tickerDateRange.start_year;
                        endYearInput.value = tickerDateRange.end_year;
                        startYearDisplay.textContent = tickerDateRange.start_year;
                        endYearDisplay.textContent = tickerDateRange.end_year;
                    } else {
                        // Fallback to default range if no ticker data available
                        startYearInput.value = 2000;
                        endYearInput.value = new Date().getFullYear();
                        startYearDisplay.textContent = 2000;
                        endYearDisplay.textContent = new Date().getFullYear();
                    }
                } else if (selectedPeriod !== 'Full Period') {
                    startYearInput.value = periodConfig.start;
                    endYearInput.value = periodConfig.end;
                    startYearDisplay.textContent = periodConfig.start;
                    endYearDisplay.textContent = periodConfig.end;
                }
            }
        });
        
        // Initial setup
        periodSelect.dispatchEvent(new Event('change'));
        
        // Update button click
        document.getElementById('updateButton').addEventListener('click', function() {
            updateAnalysis();
        });
        
        // Download buttons
        document.getElementById('downloadMatrix').addEventListener('click', downloadMatrix);
        document.getElementById('downloadReturns').addEventListener('click', downloadReturns);
        
        // Matrix type toggle handlers
        document.getElementById('cagrRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'CAGR shows annualized returns between periods';
                updateStatisticLabels('CAGR');
                // Auto-update if we have valid data
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        document.getElementById('totalReturnRadio').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('matrixTypeDescription').textContent = 'Total Return shows cumulative returns between periods';
                updateStatisticLabels('Total Return');
                // Auto-update if we have valid data
                if (isValidTicker && document.getElementById('heatmapContainer').style.display !== 'none') {
                    updateAnalysis();
                }
            }
        });
        
        // Validate initial ticker and load data
        validateTicker();
        setTimeout(function() {
            if (isValidTicker) {
                updateAnalysis();
            }
        }, 1000);
    });
    
    function updateStatisticLabels(matrixType) {
        // Update the instructions based on matrix type
        const instructionsContainer = document.getElementById('instructions');
        if (instructionsContainer) {
            const cellDescription = instructionsContainer.querySelector('li:nth-child(3)');
            if (cellDescription) {
                if (matrixType === 'Total Return') {
                    cellDescription.innerHTML = '<strong>Cell Values:</strong> Total Return percentage for that specific time period';
                } else {
                    cellDescription.innerHTML = '<strong>Cell Values:</strong> Compound Annual Growth Rate (CAGR) for that specific time period';
                }
            }
        }
        
        // Update statistic labels if data is already displayed
        if (document.getElementById('statsContainer').style.display !== 'none') {
            const bestYearElement = document.getElementById('bestSingleYearLabel');
            const worstYearElement = document.getElementById('worstSingleYearLabel');
            const tenYearElement = document.getElementById('tenYearCAGRLabel');
            const fullPeriodElement = document.getElementById('fullPeriodCAGRLabel');
            
            if (bestYearElement && bestYearElement.textContent.includes('(')) {
                const year = bestYearElement.textContent.match(/\((\d{4})\)/)[1];
                bestYearElement.textContent = `Best Single Year ${matrixType} (${year})`;
            }
            
            if (worstYearElement && worstYearElement.textContent.includes('(')) {
                const year = worstYearElement.textContent.match(/\((\d{4})\)/)[1];
                worstYearElement.textContent = `Worst Single Year ${matrixType} (${year})`;
            }
            
            if (tenYearElement && tenYearElement.textContent.includes('10-Year')) {
                const yearMatch = tenYearElement.textContent.match(/\((\d{4}-\d{4})\)/);
                if (yearMatch) {
                    tenYearElement.textContent = `10-Year ${matrixType} (${yearMatch[1]})`;
                } else {
                    tenYearElement.textContent = `10-Year ${matrixType}`;
                }
            }
            
            if (fullPeriodElement && fullPeriodElement.textContent.includes('-Year')) {
                const yearMatch = fullPeriodElement.textContent.match(/(\d+)-Year/);
                const periodMatch = fullPeriodElement.textContent.match(/\((\d{4}-\d{4})\)/);
                if (yearMatch && periodMatch) {
                    fullPeriodElement.textContent = `${yearMatch[1]}-Year ${matrixType} (${periodMatch[1]})`;
                }
            }
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    let currentTicker = 'SPY';
    let isValidTicker = true;
    let tickerDateRange = null; // Store the available date range for the current ticker
    
    // Ticker input handling
    const tickerInput = document.getElementById('tickerInput');
    const tickerSuggestions = document.getElementById('tickerSuggestions');
    const tickerInfo = document.getElementById('tickerInfo');
    const tickerError = document.getElementById('tickerError');
    const validateButton = document.getElementById('validateTicker');
    
    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Search for tickers
    const searchTickers = debounce(function(query) {
        if (query.length < 1) {
            tickerSuggestions.style.display = 'none';
            return;
        }
        
        fetch(`/api/search-tickers/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    tickerSuggestions.innerHTML = '';
                    data.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'ticker-suggestion-item';
                        div.innerHTML = `
                            <span class="ticker-suggestion-symbol">${item.symbol}</span>
                            <span class="ticker-suggestion-exchange">${item.exchange}</span><br>
                            <span class="ticker-suggestion-name">${item.name}</span>
                        `;
                        div.addEventListener('click', function() {
                            tickerInput.value = item.symbol;
                            tickerSuggestions.style.display = 'none';
                            validateTicker();
                        });
                        tickerSuggestions.appendChild(div);
                    });
                    tickerSuggestions.style.display = 'block';
                } else {
                    tickerSuggestions.style.display = 'none';
                }
            });
    }, 300);
    
    // Ticker input events
    tickerInput.addEventListener('input', function() {
        searchTickers(this.value);
        tickerInput.classList.remove('ticker-input-valid', 'ticker-input-invalid');
        tickerError.style.display = 'none';
        tickerInfo.textContent = '';
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!tickerInput.contains(e.target) && !tickerSuggestions.contains(e.target)) {
            tickerSuggestions.style.display = 'none';
        }
    });
    
    // Validate ticker
    function validateTicker() {
        const ticker = tickerInput.value.trim().toUpperCase();
        if (!ticker) {
            tickerError.textContent = 'Please enter a ticker symbol';
            tickerError.style.display = 'block';
            tickerInput.classList.add('ticker-input-invalid');
            isValidTicker = false;
            return;
        }
        
        tickerInfo.textContent = 'Validating...';
        tickerError.style.display = 'none';
        
        fetch('/api/validate-ticker/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                currentTicker = data.ticker;
                isValidTicker = true;
                tickerDateRange = data.date_range || null; // Store the available date range
                tickerInput.classList.remove('ticker-input-invalid');
                tickerInput.classList.add('ticker-input-valid');
                tickerError.style.display = 'none';
                
                let infoText = '';
                if (data.info && data.info.name) {
                    infoText = `<small class="text-success">‚úì ${data.info.name} (${data.info.exchange})`;
                } else {
                    infoText = '<small class="text-success">‚úì Valid ticker';
                }
                
                // Add date range info if available
                if (tickerDateRange) {
                    infoText += ` ‚Ä¢ Available: ${tickerDateRange.start_year}-${tickerDateRange.end_year}`;
                }
                infoText += '</small>';
                
                tickerInfo.innerHTML = infoText;
                
                // Update Full Period option if it's currently selected
                if (document.getElementById('periodSelect').value === 'Full Period' && tickerDateRange) {
                    document.getElementById('startYear').value = tickerDateRange.start_year;
                    document.getElementById('endYear').value = tickerDateRange.end_year;
                    document.getElementById('startYearDisplay').textContent = tickerDateRange.start_year;
                    document.getElementById('endYearDisplay').textContent = tickerDateRange.end_year;
                }
            } else {
                isValidTicker = false;
                tickerDateRange = null;
                tickerInput.classList.remove('ticker-input-valid');
                tickerInput.classList.add('ticker-input-invalid');
                tickerError.textContent = data.error || 'Invalid ticker symbol';
                tickerError.style.display = 'block';
                tickerInfo.textContent = '';
            }
        })
        .catch(error => {
            isValidTicker = false;
            tickerError.textContent = 'Error validating ticker';
            tickerError.style.display = 'block';
            tickerInfo.textContent = '';
        });
    }
    
    validateButton.addEventListener('click', validateTicker);
    
    // Enter key to validate
    tickerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            validateTicker();
        }
    });
    
    // Performance Overview Update Function
    function updatePerformanceOverview(performanceData, ticker, startYear, endYear) {
        // Check if performanceData exists and has the required structure
        if (!performanceData || typeof performanceData !== 'object') {
            console.error('Performance data is null or invalid:', performanceData);
            return;
        }
        
        const formatPercent = (value, decimals = 2) => {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            return (value * 100).toFixed(decimals) + '%';
        };
        
        const formatNumber = (value, decimals = 2) => {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            return value.toFixed(decimals);
        };
        
        const formatDays = (days) => {
            if (days === null || days === undefined) return 'N/A';
            if (days > 365) return `${Math.round(days / 365)} years`;
            return `${days} days`;
        };
        
        const addColorClass = (element, value, positiveGood = true) => {
            element.classList.remove('positive', 'negative', 'neutral');
            if (value === null || value === undefined || isNaN(value)) {
                element.classList.add('neutral');
            } else if ((value > 0 && positiveGood) || (value < 0 && !positiveGood)) {
                element.classList.add('positive');
            } else if ((value < 0 && positiveGood) || (value > 0 && !positiveGood)) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        };
        
        // Return Metrics
        if (performanceData.return_metrics) {
            const perfCagr = document.getElementById('perf-cagr');
            const perfTotalReturn = document.getElementById('perf-total-return');
            const perfBestYear = document.getElementById('perf-best-year');
            const perfWorstYear = document.getElementById('perf-worst-year');
            const perfWinRate = document.getElementById('perf-win-rate');
            
            perfCagr.textContent = formatPercent(performanceData.return_metrics.cagr);
            perfTotalReturn.textContent = formatPercent(performanceData.return_metrics.total_return);
            perfBestYear.textContent = `${formatPercent(performanceData.return_metrics.best_year)} (${performanceData.return_metrics.best_year_date})`;
            perfWorstYear.textContent = `${formatPercent(performanceData.return_metrics.worst_year)} (${performanceData.return_metrics.worst_year_date})`;
            perfWinRate.textContent = formatPercent(performanceData.return_metrics.win_rate);
            
            addColorClass(perfCagr, performanceData.return_metrics.cagr);
            addColorClass(perfTotalReturn, performanceData.return_metrics.total_return);
            addColorClass(perfBestYear, performanceData.return_metrics.best_year);
            addColorClass(perfWorstYear, performanceData.return_metrics.worst_year, false);
            addColorClass(perfWinRate, performanceData.return_metrics.win_rate);
        }
        
        
        // Risk Metrics
        if (performanceData.risk_metrics) {
            const perfVolatility = document.getElementById('perf-volatility');
            const perfMaxDD = document.getElementById('perf-max-dd');
            const perfRecovery = document.getElementById('perf-recovery');
            const perfVar = document.getElementById('perf-var');
            const perfPain = document.getElementById('perf-pain');
            
            perfVolatility.textContent = formatPercent(performanceData.risk_metrics.volatility);
            perfMaxDD.textContent = formatPercent(performanceData.risk_metrics.maximum_drawdown);
            perfRecovery.textContent = formatDays(performanceData.risk_metrics.recovery_days);
            perfVar.textContent = formatPercent(performanceData.risk_metrics.var_5);
            perfPain.textContent = formatPercent(performanceData.risk_metrics.pain_index);
            
            addColorClass(perfVolatility, performanceData.risk_metrics.volatility, false);
            addColorClass(perfMaxDD, performanceData.risk_metrics.maximum_drawdown, false);
            addColorClass(perfVar, performanceData.risk_metrics.var_5, false);
            addColorClass(perfPain, performanceData.risk_metrics.pain_index, false);
        }
        
        // Risk-Adjusted Metrics
        if (performanceData.risk_adjusted_metrics) {
            const perfSharpe = document.getElementById('perf-sharpe');
            const perfSortino = document.getElementById('perf-sortino');
            const perfCalmar = document.getElementById('perf-calmar');
            
            perfSharpe.textContent = formatNumber(performanceData.risk_adjusted_metrics.sharpe_ratio);
            perfSortino.textContent = formatNumber(performanceData.risk_adjusted_metrics.sortino_ratio);
            perfCalmar.textContent = formatNumber(performanceData.risk_adjusted_metrics.calmar_ratio);
            
            addColorClass(perfSharpe, performanceData.risk_adjusted_metrics.sharpe_ratio);
            addColorClass(perfSortino, performanceData.risk_adjusted_metrics.sortino_ratio);
            addColorClass(perfCalmar, performanceData.risk_adjusted_metrics.calmar_ratio);
        }
        
        // Relative Metrics
        if (performanceData.relative_metrics) {
            const perfBeta = document.getElementById('perf-beta');
            const perfAlpha = document.getElementById('perf-alpha');
            const perfRSquared = document.getElementById('perf-r-squared');
            const perfTreynor = document.getElementById('perf-treynor');
            const perfInfoRatio = document.getElementById('perf-info-ratio');
            
            perfBeta.textContent = formatNumber(performanceData.relative_metrics.beta);
            perfAlpha.textContent = formatPercent(performanceData.relative_metrics.alpha);
            perfRSquared.textContent = formatNumber(performanceData.relative_metrics.r_squared);
            perfTreynor.textContent = formatNumber(performanceData.relative_metrics.treynor_ratio);
            perfInfoRatio.textContent = formatNumber(performanceData.relative_metrics.information_ratio);
            
            addColorClass(perfAlpha, performanceData.relative_metrics.alpha);
            addColorClass(perfTreynor, performanceData.relative_metrics.treynor_ratio);
            addColorClass(perfInfoRatio, performanceData.relative_metrics.information_ratio);
        }
        
        // Period Information
        if (performanceData.period_info) {
            const perfPeriodInfo = document.getElementById('perf-period-info');
            perfPeriodInfo.textContent = `${ticker} from ${startYear} to ${endYear} (${performanceData.period_info.num_years.toFixed(1)} years, ${performanceData.period_info.num_observations} observations)`;
        }
    }
    
    function updateAnalysis() {
        const ticker = tickerInput.value.trim().toUpperCase();
        const period = document.getElementById('periodSelect').value;
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        
        if (!ticker) {
            tickerError.textContent = 'Please enter a ticker symbol';
            tickerError.style.display = 'block';
            return;
        }
        
        if (!isValidTicker) {
            tickerError.textContent = 'Please validate the ticker symbol first';
            tickerError.style.display = 'block';
            return;
        }
        
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('heatmapContainer').style.display = 'none';
        document.getElementById('instructions').style.display = 'none';
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('performanceContainer').style.display = 'none';
        document.getElementById('downloadSection').style.display = 'none';
        
        // Get selected matrix type
        const matrixType = document.querySelector('input[name="matrixType"]:checked').value;
        
        // Prepare request data
        const requestData = {
            ticker: ticker,
            period: period,
            start_year: startYear,
            end_year: endYear,
            matrix_type: matrixType
        };
        
        // Make API request
        fetch('/api/get-data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update year inputs if Full Period was selected
            if (period === 'Full Period' && data.available_years) {
                document.getElementById('startYear').value = data.available_years.min;
                document.getElementById('endYear').value = data.available_years.max;
                document.getElementById('startYearDisplay').textContent = data.available_years.min;
                document.getElementById('endYearDisplay').textContent = data.available_years.max;
            }
            
            // Clear any previous adjustment messages
            const existingAdjustmentAlerts = document.querySelectorAll('.alert-info.adjustment-alert');
            existingAdjustmentAlerts.forEach(alert => alert.remove());
            
            // Show adjustment message if date range was auto-adjusted
            if (data.date_adjusted && data.adjustment_message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible fade show adjustment-alert';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>üìÖ Date Range Adjusted:</strong> ${data.adjustment_message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.getElementById('errorAlert').parentNode.insertBefore(alertDiv, document.getElementById('errorAlert').nextSibling);
            }
            
            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
            
            // Show containers
            document.getElementById('heatmapContainer').style.display = 'block';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'flex';
            document.getElementById('performanceContainer').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            
            // Render heatmap
            Plotly.newPlot('heatmapPlot', data.heatmap.data, data.heatmap.layout);
            
            // Update statistics
            const currentMatrixType = document.querySelector('input[name="matrixType"]:checked').value;
            if (data.stats.best_single_year) {
                document.getElementById('bestSingleYear').textContent = data.stats.best_single_year.value.toFixed(1) + '%';
                document.getElementById('bestSingleYearLabel').textContent = `Best Single Year ${currentMatrixType} (${data.stats.best_single_year.year})`;
            }
            
            if (data.stats.worst_single_year) {
                document.getElementById('worstSingleYear').textContent = data.stats.worst_single_year.value.toFixed(1) + '%';
                document.getElementById('worstSingleYearLabel').textContent = `Worst Single Year ${currentMatrixType} (${data.stats.worst_single_year.year})`;
            }
            
            if (data.stats.ten_year_metric) {
                document.getElementById('tenYearCAGR').textContent = data.stats.ten_year_metric.value.toFixed(1) + '%';
                document.getElementById('tenYearCAGRLabel').textContent = `10-Year ${data.stats.ten_year_metric.type} (${data.stats.ten_year_metric.start}-${data.stats.ten_year_metric.end})`;
            } else {
                const currentMatrixType = document.querySelector('input[name="matrixType"]:checked').value;
                document.getElementById('tenYearCAGR').textContent = 'N/A';
                document.getElementById('tenYearCAGRLabel').textContent = `10-Year ${currentMatrixType}`;
            }
            
            if (data.stats.full_period_metric) {
                document.getElementById('fullPeriodCAGR').textContent = data.stats.full_period_metric.value.toFixed(1) + '%';
                document.getElementById('fullPeriodCAGRLabel').textContent = `${data.stats.full_period_metric.years}-Year ${data.stats.full_period_metric.type} (${data.stats.full_period_metric.start}-${data.stats.full_period_metric.end})`;
            }
            
            // Update performance overview
            if (data.performance_overview) {
                updatePerformanceOverview(data.performance_overview, ticker, startYear, endYear);
            }
        })
        .catch(error => {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'block';
            document.getElementById('errorAlert').textContent = '‚ö†Ô∏è ' + error.message;
        });
    }
    
    function downloadMatrix() {
        const ticker = tickerInput.value.trim().toUpperCase();
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        const matrixType = document.querySelector('input[name="matrixType"]:checked').value;
        
        if (!ticker || !isValidTicker) {
            alert('Please enter and validate a ticker symbol first');
            return;
        }
        
        const requestData = {
            ticker: ticker,
            start_year: startYear,
            end_year: endYear,
            matrix_type: matrixType
        };
        
        fetch('/api/download-matrix/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const matrixName = matrixType.replace(' ', '_');
            a.download = `PearsonCreek_${ticker}_${matrixName}_Matrix_${startYear}_${endYear}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    }
    
    function downloadReturns() {
        const ticker = tickerInput.value.trim().toUpperCase();
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        
        if (!ticker || !isValidTicker) {
            alert('Please enter and validate a ticker symbol first');
            return;
        }
        
        // Use current ticker for download
        const tickers = [ticker];
        
        const requestData = {
            start_year: startYear,
            end_year: endYear,
            tickers: tickers.length > 0 ? tickers : [ticker]
        };
        
        fetch('/api/download-returns/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PearsonCreek_Annual_Returns_${startYear}_${endYear}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    }
</script>
{% endblock %}